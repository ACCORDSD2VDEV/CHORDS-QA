---
output:  
    word_document :
        reference_docx: QaTableStyle6.docx
        toc: yes
params: 
    DBServerName: 
        label: "Database Server Name:"
        input: text
        value: ""
        placeholder: "Enter your VDW Database Server Name"
    DBName:
        label: "Database Name:"
        input: text
        value: ""
        placeholder: "Enter your VDW Database Name"
    DBUser:
        label: "Database User Name"
        input: text
        value: ""
        placeholder: "leave blank if using windows authentication for your server"
    DBPassword:
        label: "Database Password"
        input: password
        value: ""
        placeholder: "leave blank if using windows authentication for your server"
---

```{r setup, include=FALSE}
library(RODBC)
library(knitr)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE,
                message = FALSE,
                warning = FALSE)
startTime <- Sys.time()
# connection to sql server
if (nchar(params$DBUser) == 0)
{
	con <- DBI::dbConnect(odbc::odbc(),
                      Driver = "SQL Server",
                      Server = params$DBServerName,
                      Database = params$DBName)
	sqldb <- odbcDriverConnect(paste('driver={SQL Server};server=',params$DBServerName,';database=',params$DBName, sep=""), readOnlyOptimize = TRUE)
} else {
	con <- DBI::dbConnect(odbc::odbc(),
                      Driver = "SQL Server",
                      Server = params$DBServerName,
                      Database = params$DBName,
                      UID = params$DBUser,
                      PWD = params$DBPassword)
	sqldb <- odbcDriverConnect(paste('driver={SQL Server};uid=',params$UserName,';pwd=',params$Password,';server=',params$DBServerName,';database=',params$DBName, sep=""), readOnlyOptimize = TRUE)
}
#Checks to see if partner is using table replacements.
#Checks if the CHORDS_TableNames table exists in their VDW.  If not, check if they are using a csv.  If not, applies default table names.
dfChordsTbls <- odbc::dbGetQuery(con, "                    
    IF EXISTS
    (
        SELECT
            *
        FROM  SYSOBJECTS
        WHERE XTYPE = 'U' AND
              NAME = 'CHORDS_TableNames'
    )
    BEGIN
        SELECT
            [ORG_NAME],
            [NEW_NAME]
        FROM[CHORDS_TABLENAMES];
    END; ")
if (nrow(dfChordsTbls) == 0  && exists("outputdir")){
  tableReplaceFile <-  paste0(outputdir, "\\tablereplace.csv")
  if (file.exists(tableReplaceFile)){
    print("updating for QA using tablereplace.csv")
    dfChordsTbls <- read.csv2(tableReplaces, header = TRUE, sep = ",", stringsAsFactors=FALSE)
  }
}
if (nrow(dfChordsTbls) > 0){
  demographics <- ifelse("demographics" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("demographics"), tolower(dfChordsTbls$ORG_NAME))], "demographics")
  encounters <- ifelse("encounters" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("encounters"), tolower(dfChordsTbls$ORG_NAME))], "encounters")
  census_location <- ifelse("census_location" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("census_location"), tolower(dfChordsTbls$ORG_NAME))], "census_location")
  diagnoses <- ifelse("diagnoses" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("diagnoses"), tolower(dfChordsTbls$ORG_NAME))], "diagnoses")
  vital_signs <- ifelse("vital_signs" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("vital_signs"), tolower(dfChordsTbls$ORG_NAME))], "vital_signs")
  lab_results <- ifelse("lab_results" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("lab_results"), tolower(dfChordsTbls$ORG_NAME))], "lab_results")
  procedures <- ifelse("procedures" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("procedures"), tolower(dfChordsTbls$ORG_NAME))], "procedures")
  benefit <- ifelse("benefit" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("benefit"), tolower(dfChordsTbls$ORG_NAME))], "benefit")
  linkage <- ifelse("linkage" %in% tolower(dfChordsTbls$ORG_NAME),  dfChordsTbls$NEW_NAME[match(tolower("linkage"), tolower(dfChordsTbls$ORG_NAME))], "linkage")
  
} else {
  # Names of database tables
  demographics    <- "demographics"
  encounters      <- "encounters"
  census_location <- "census_location"
  diagnoses       <- "diagnoses"
  vital_signs     <- "vital_signs"
  lab_results     <- "lab_results"
  procedures      <- "procedures"
  benefit        <- "benefit"
  linkage        <- "linkage"
}
# set to zero for full read of the database
# set to a positive number to limit the number of rows read from each table
maxQryRows <- 0
# load lib for SQL server connectivity
# install.packages("RODBC")
# install.packages("knitr")
# install.packages("tidyverse")
```

## CHORDS QA Report: VDW P1 Tables

The purpose of the data quality program is to characterize the data in CHORDS VDW 3.1 priority level 1 (P1) tables. The P1 tables include the following: DEMOGRAPHICS, ENCOUNTERS, CENSUS_LOCATION, DIAGNOSES, VITAL_SIGNS, and BENEFITS. The program uses a series of SQL queries operationalized using RStudio to produce this report. These tables provide descriptive information about data stored in a data partnerâ€™s VDW and can be used to assess data model conformance, data plausibility, and data completeness. This data quality report was generated from CHORDS `r params$DBName`.

## Information about the QA Program 
Data Partner: TEST
Analyst: Emily Bacon
Query Run Date:  `r Sys.Date()`


```{r supporting data and functions, include = FALSE}
## helper functions
 # returns a vector with the column numbers of character variables in the data frame
charVars <- function(df) grep('^ch',sapply(df,class))
 # trims all character variables in a dataframe, sets blank to NA
trimChrVars <- function(df){
for(i in charVars(df)){
  df[,i] <- gsub('\\s+$','',df[,i])
  df[,i] <- ifelse(nchar(df[,i])==0,NA,df[,i])
}
  df
}
# age category calculator
ageCatCalc <- function(age){
  ageCat <- factor(
    ifelse(is.na(age)==TRUE, 0,
           ifelse(age<0              , 1, 
                  ifelse(age>=0 & age<2, 2,
                         ifelse(age>=2 & age<5, 3, 
                                ifelse(age>=5 & age<10, 4, 
                                       ifelse (age>=10 & age<15, 5, 
                                               ifelse(age>=15 & age<19, 6,
                                                      ifelse(age>=19 & age<22, 7,
                                                             ifelse(age>=22 & age<45, 8, 
                                                                    ifelse(age>=45 & age<65, 9, 
                                                                           ifelse(age>=65 & age<75, 10, 
                                                                                  ifelse(age>=75 & age<90, 11,
                                                                                         ifelse(age>=90 , 12, 13)))))) ))))))),
    levels=0:13,
    labels=c('Missing','Negative','0-1','2-4','5-9','10-14','15-18','19-21','22-44','45-64','65-74','75-89','90+','Other')
  )
  
  return(ageCat)
}
# supporting look up tables
stateCnty <- chordsTables::stateCnty
ccsMDxI9 <- chordsTables::ccsMDxI9
ccsMDxI10 <- chordsTables::ccsMDxI10
ccsSDxI9 <- chordsTables::ccsSDxI9
icdLU <- rbind(ccsMDxI10[c('dxCdTp','dxDesc')],ccsSDxI9[c('dxCdTp','dxDesc')]) 
# ISO language lookup
isoLang <- chordsTables::isoLang 
 
# VDW value sets
valSets <- chordsTables::valSets
```

## Data Quality Report Results

## Table 1. Records, Patients, Encounters, and Date Ranges by Table

This table contains summary counts and date ranges by table. Distinct encounters and patients are shown for applicable tables. Data ranges should be used to compare data time windows between tables.

```{r tab1_sum_stats, echo = F, include=T, error=T}
tab1_dem <- odbc::dbGetQuery(con, paste0("select count(*) as nrows, 
	count(distinct person_id) as npats
	from ", demographics))
tab1_dem <- data.frame(nrows = tab1_dem$nrows, 
                       npats = tab1_dem$npats, 
                       nencts = NA, 
                       fieldname = NA, 
                       mindt = NA,
                       maxdt = NA)

tab1_enc <- odbc::dbGetQuery(con, paste0("select count(*) as nrows,
	count(distinct person_id) as npats,
  count(distinct enc_id) as nencts,
  'ADATE' as fieldname,
	min(ADATE) as mindt,
	max(ADATE) as maxdt
	from ", encounters))

tab1_loc <- odbc::dbGetQuery(con, paste0("select count(*) as nrows, 
	count(distinct person_id) as npats
	from ", census_location))
tab1_loc <- data.frame(nrows = tab1_loc$nrows, 
                       npats = tab1_loc$npats, 
                       nencts = NA, 
                       fieldname = NA, 
                       mindt = NA, 
                       maxdt = NA)

tab1_dx <- odbc::dbGetQuery(con, paste0("select count(*) as nrows, 
	count(distinct person_id) as npats,
  'ADATE' as fieldname,
  count(distinct enc_id) as nencts,
	min(ADATE) as mindt,
	max(ADATE) as maxdt
	from ", diagnoses))
tab1_vs <- odbc::dbGetQuery(con, paste0("select count(*) as nrows,
  count(distinct person_id) as npats,
  'MEASURE_DATE' as fieldname,
  count(distinct enc_id) as nencts,
	min(measure_date) as mindt,
	max(measure_date) as maxdt
	from ", vital_signs))


tab1_ben <- odbc::dbGetQuery(con, paste0("select count(*) as nrows,
  count(distinct person_id) as npats,
  'BENEFIT_DATE' as fieldname,
  count(distinct enc_id) as nencts,
	cast(min(benefit_date) as varchar) as mindt,
	cast(max(benefit_date) as varchar) as maxdt
	from ", benefit))





tab1_all <- bind_rows(tab1_dem, tab1_enc, tab1_loc, tab1_dx, tab1_vs, tab1_ben) %>% 
  bind_cols(Table = c("DEMOGRAPHICS", "ENCOUNTERS", "CENSUS_LOCATION", "DIAGNOSES", "VITAL_SIGNS", "BENEFITS"), .)







```

```{r tab1_disp, echo = F, include=T, error=T}
kable(tab1_all, col.names = c("Table", "Records", "Patients", "Encounters", "Date Field", "Min Date", "Max Date"), align = 'c', format.args = list(big.mark = ",")) 
  
```

## Table 2. Missingness Variables across P1 Tables

This table contains record counts for null and unknown values across P1 tables.


```{r tab2_res, echo = F, include=T, error=T}
tab2_demo_null <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN BIRTH_DATE IS NULL THEN 1 ELSE 0 END) as BIRTH_DATE,
   SUM(CASE WHEN GENDER IS NULL THEN 1 ELSE 0 END) as GENDER,
   SUM(CASE WHEN PRIMARY_LANGUAGE IS NULL THEN 1 ELSE 0 END) as PRIMARY_LANGUAGE,
   SUM(CASE WHEN NEEDS_INTERPRETER IS NULL THEN 1 ELSE 0 END) as NEEDS_INTERPRETER,
   SUM(CASE WHEN RACE1 IS NULL THEN 1 ELSE 0 END) as RACE1,
   SUM(CASE WHEN RACE2 IS NULL THEN 1 ELSE 0 END) as RACE2,
   SUM(CASE WHEN RACE3 IS NULL THEN 1 ELSE 0 END) as RACE3,
   SUM(CASE WHEN RACE4 IS NULL THEN 1 ELSE 0 END) as RACE4,
   SUM(CASE WHEN RACE5 IS NULL THEN 1 ELSE 0 END) as RACE5,
   SUM(CASE WHEN HISPANIC IS NULL THEN 1 ELSE 0 END) as HISPANIC,
   SUM(CASE WHEN SEXUAL_ORIENTATION IS NULL THEN 1 ELSE 0 END) as SEXUAL_ORIENTATION,
   SUM(CASE WHEN GENDER_IDENTITY IS NULL THEN 1 ELSE 0 END) as GENDER_IDENTITY
      FROM ", demographics))
tab2_demo_null2 <- data.frame(table = rep("DEMOGRAPHICS", ncol(tab2_demo_null)), var = names(tab2_demo_null), records_null = t(tab2_demo_null)[,1])
row.names(tab2_demo_null2) <- NULL
tab2_enc_null <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN ADATE IS NULL THEN 1 ELSE 0 END) as ADATE,
   SUM(CASE WHEN DDATE IS NULL THEN 1 ELSE 0 END) as DDATE,
   SUM(CASE WHEN PROVIDER IS NULL THEN 1 ELSE 0 END) as PROVIDER,
   SUM(CASE WHEN ENCTYPE IS NULL THEN 1 ELSE 0 END) as ENCOUNTER_SUBTYPE
      FROM ", encounters))
tab2_enc_null2 <- data.frame(table = rep("ENCOUNTERS", ncol(tab2_enc_null)), var = names(tab2_enc_null), records_null = t(tab2_enc_null)[,1])
row.names(tab2_enc_null2) <- NULL
tab2_cl_null <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN GEOCODE IS NULL THEN 1 ELSE 0 END) as GEOCODE,
   SUM(CASE WHEN CITY_GEOCODE IS NULL THEN 1 ELSE 0 END) as CITY_GEOCODE
      FROM ", census_location))
tab2_cl_null2 <- data.frame(table = rep("CENSUS_LOCATION", ncol(tab2_cl_null)), var = names(tab2_cl_null), records_null = t(tab2_cl_null)[,1])
row.names(tab2_cl_null2) <- NULL
tab2_dx_null <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN ENC_ID IS NULL THEN 1 ELSE 0 END) as ENC_ID,
   SUM(CASE WHEN ADATE IS NULL THEN 1 ELSE 0 END) as ADATE,
   SUM(CASE WHEN DX IS NULL THEN 1 ELSE 0 END) as DX,
   SUM(CASE WHEN PRINCIPAL_DX IS NULL THEN 1 ELSE 0 END) as PRINCIPAL_DX,
   SUM(CASE WHEN PRIMARY_DX IS NULL THEN 1 ELSE 0 END) as PRIMARY_DX
      FROM ", diagnoses))
tab2_dx_null2 <- data.frame(table = rep("DIAGNOSES", ncol(tab2_dx_null)), var = names(tab2_dx_null), records_null = t(tab2_dx_null)[,1])
row.names(tab2_dx_null2) <- NULL
tab2_vs_null <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN ENC_ID IS NULL THEN 1 ELSE 0 END) as ENC_ID,
   SUM(CASE WHEN ENCTYPE IS NULL THEN 1 ELSE 0 END) as ENCTYPE,
   SUM(CASE WHEN HT IS NULL THEN 1 ELSE 0 END) as HT,
   SUM(CASE WHEN WT IS NULL THEN 1 ELSE 0 END) as WT,
   SUM(CASE WHEN DIASTOLIC IS NULL THEN 1 ELSE 0 END) as DIASTOLIC,
   SUM(CASE WHEN SYSTOLIC IS NULL THEN 1 ELSE 0 END) as SYSTOLIC,
   SUM(CASE WHEN HT_RAW IS NULL THEN 1 ELSE 0 END) as HT_RAW,
   SUM(CASE WHEN WT_RAW IS NULL THEN 1 ELSE 0 END) as WT_RAW,
   SUM(CASE WHEN BMI_RAW IS NULL THEN 1 ELSE 0 END) as BMI_RAW,
   SUM(CASE WHEN DIASTOLIC_RAW IS NULL THEN 1 ELSE 0 END) as DIASTOLIC_RAW,
   SUM(CASE WHEN SYSTOLIC_RAW IS NULL THEN 1 ELSE 0 END) as SYSTOLIC_RAW,
   SUM(CASE WHEN BP_TYPE IS NULL THEN 1 ELSE 0 END) as BP_TYPE,
   SUM(CASE WHEN POSITION IS NULL THEN 1 ELSE 0 END) as POSITION,
   SUM(CASE WHEN HEAD_CIR_RAW IS NULL THEN 1 ELSE 0 END) as HEAD_CIR_RAW,
   SUM(CASE WHEN RESPIR_RAW IS NULL THEN 1 ELSE 0 END) as RESPIR_RAW,
   SUM(CASE WHEN TEMP_RAW IS NULL THEN 1 ELSE 0 END) as TEMP_RAW,
   SUM(CASE WHEN PULSE_RAW IS NULL THEN 1 ELSE 0 END) as PULSE_RAW
      FROM ", vital_signs))
tab2_vs_null2 <- data.frame(table = rep("VITAL_SIGNS", ncol(tab2_vs_null)), var = names(tab2_vs_null), records_null = t(tab2_vs_null)[,1])
row.names(tab2_vs_null2) <- NULL
tab2_null <- bind_rows(tab2_demo_null2, tab2_enc_null2, tab2_cl_null2, tab2_dx_null2, tab2_vs_null2) %>% 
  mutate(
    pct_rec = ifelse(table == "DEMOGRAPHICS", (records_null / tab1_dem$nrows * 100), 
                     ifelse(table == "ENCOUNTERS", (records_null / tab1_enc$nrows * 100), 
                             ifelse(table == "CENSUS_LOCATION", (records_null / tab1_loc$nrows * 100), 
                                     ifelse(table == "DIAGNOSES", (records_null / tab1_dx$nrows * 100), 
                                             ifelse(table == "VITAL_SIGNS", (records_null / tab1_vs$nrows * 100), NA)))))
  )
tab2_demo_uk <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN GENDER = 'U' THEN 1 ELSE 0 END) as GENDER,
   SUM(CASE WHEN PRIMARY_LANGUAGE = 'UNK' THEN 1 ELSE 0 END) as PRIMARY_LANGUAGE,
   SUM(CASE WHEN NEEDS_INTERPRETER = 'U' THEN 1 ELSE 0 END) as NEEDS_INTERPRETER,
   SUM(CASE WHEN RACE1 = 'UN' THEN 1 ELSE 0 END) as RACE1,
   SUM(CASE WHEN RACE2 = 'UN' THEN 1 ELSE 0 END) as RACE2,
   SUM(CASE WHEN RACE3 = 'UN' THEN 1 ELSE 0 END) as RACE3,
   SUM(CASE WHEN RACE4 = 'UN' THEN 1 ELSE 0 END) as RACE4,
   SUM(CASE WHEN RACE5 = 'UN' THEN 1 ELSE 0 END) as RACE5,
   SUM(CASE WHEN HISPANIC = 'U' THEN 1 ELSE 0 END) as HISPANIC,
   SUM(CASE WHEN SEXUAL_ORIENTATION = 'UN' THEN 1 ELSE 0 END) as SEXUAL_ORIENTATION,
   SUM(CASE WHEN GENDER_IDENTITY = 'UN' THEN 1 ELSE 0 END) as GENDER_IDENTITY
      FROM ", demographics))
tab2_demo_uk2 <- data.frame(table = rep("DEMOGRAPHICS", ncol(tab2_demo_uk)), var = names(tab2_demo_uk), records_uk = t(tab2_demo_uk)[,1])
row.names(tab2_demo_uk2) <- NULL
tab2_enc_uk <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN PROVIDER = 'UNKNOWN' THEN 1 ELSE 0 END) as PROVIDER
      FROM ", encounters))
tab2_enc_uk2 <- data.frame(table = rep("ENCOUNTERS", ncol(tab2_enc_uk)), var = names(tab2_enc_uk), records_uk = t(tab2_enc_uk)[,1])
row.names(tab2_enc_uk2) <- NULL
tab2_uk <- bind_rows(tab2_demo_uk2, tab2_enc_uk2) %>% 
  mutate(
    pct_rec_uk = ifelse(table == "DEMOGRAPHICS", (records_uk / tab1_dem$nrows * 100), 
                                     ifelse(table == "ENCOUNTERS", (records_uk / tab1_enc$nrows * 100), NA))
  )
tab2_all <- left_join(tab2_null, tab2_uk, by = c("table", "var"))
```

```{r tab2_disp, echo = F, include=T, error=T}
kable(tab2_all, col.names = c("Table", "Variable", "Null Records", "Percent of Records Null", "Unknown Records", "Percent of Records Unknown"), digits = 2, format.args = list(big.mark = ","))
```


## Examination of the DEMOGRAPHICS Table

## Table 3. Overall Demographics

```{r Demographic table, include=F}
nDemogRows <- sqlQuery(sqldb, paste0("select  count(*) as nDemogRows FROM ",   demographics)) 
demogSummary <- sqlQuery(sqldb, 
                  paste('select  count(*) as nDemogRows ',
                                ', count(distinct person_id) as nPatsDemog ',
		                            ', sum(nPatsWithEncs) as nPatsWithEncs ',
		                            ', sum(nPatsWithLoc) as nPatsWithLoc ',
		                            ', sum(nPatsWithDiag) as nPatsWithDiag ',
		                            ', sum(nPatsWithVital) as nPatsWithVital' ,
		                            '  FROM (select distinct',
		                                          ' person_id',
		                                         ', case when person_id in (select distinct person_id from ', encounters,' ) then 1 else 0 end as nPatsWithEncs ',
		                                        ',  case when person_id in (select distinct person_id from ', census_location,' ) then 1 else 0 end as nPatsWithLoc ',
		                                        ',  case when person_id in (select distinct person_id from ', diagnoses,' ) then 1 else 0 end as nPatsWithDiag ',
		                                        ',  case when person_id in (select distinct person_id from', vital_signs,' ) then 1 else 0 end as nPatsWithVital ',
		                                        '  FROM ',  demographics,') as q',
                        sep=" "
                 ),
                 max=maxQryRows
                  )
gc()
demogSummary <- cbind(demogSummary,nDemogRows)
demogTable <-
  with(demogSummary,
  rbind(
    c('Total rows in the demographic table'         ,nDemogRows    ,round(100*nDemogRows/nPatsDemog,1)),
    c('Unique patients in the demographic table'    ,nPatsDemog    ,round(100*nPatsDemog/nPatsDemog,1)),
    c('Unique patients found in CENSUS_LOCATION'    ,nPatsWithLoc  ,round(100*nPatsWithLoc/nPatsDemog,1)),
    c('Unique patients found in DIAGNOSES'          ,nPatsWithDiag ,round(100*nPatsWithDiag/nPatsDemog,1)),
    c('Unique patients found in VITAL_SIGNS'        ,nPatsWithVital,round(100*nPatsWithVital/nPatsDemog,1))
  )
)
```

```{r tab3_disp, echo = F, include=T, error=T}
knitr::kable(demogTable, col.names=c("Characteristic","Frequency","Percent of unique patients"), row.names=FALSE, format.args = list(big.mark = ","))
```

`r ifelse(demogSummary$nDemogRows==demogSummary$nPatsDemog," ","The demographics table has duplicate rows, by person_id")`

 
```{r demographic counts, include=F}
demogCounts <- sqlQuery(sqldb, 
                  paste('SELECT gender, gender_identity, sexual_orientation, primary_language, race1, race2, race3, race4, race5, hispanic, count(*) as nRows',
                        'FROM ', demographics,
                        'group by gender, gender_identity, sexual_orientation, primary_language, race1, race2, race3, race4, race5, hispanic',
                        sep=" "
                        ),
                 as.is=c(TRUE,TRUE,TRUE,TRUE),
                 max=maxQryRows
                  )
demogCounts <- trimChrVars(demogCounts)
```

## Table 4. Top 5 Patient Primary Languages

```{r primary language, echo = F, include=T, error=T}
primLang <- demogCounts %>% 
            group_by(primary_language) %>% 
            summarise(langCnt = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(langTot = sum(langCnt), 
                  langPct = round(100*langCnt/langTot,1)
                  )

primLang <- within(merge(primLang,isoLang[c('code3B','InEnglish')],by.x='primary_language', by.y='code3B', all.x=T) %>% arrange(desc(langPct)) ,{
    InEnglish <- ifelse(!is.na(InEnglish),InEnglish, ifelse(is.na(primary_language) , 'Missing', 'Invalid'))
})
```

```{r tab4_disp, echo = F, include=T, error=T}
knitr::kable(primLang[1:5, c('primary_language', 'InEnglish','langCnt','langPct')], 
            col.names=     c("ISO Language","Language name ","Frequency","Percent"), 
            row.names=FALSE, 
            format.args = list(big.mark = ","))
```

## Table 4.1. Other and Unknown Language Count 

```{r other/missing primary language, echo = F, include=T, error=T}

unkLang <- primLang[ which(primLang$primary_language=="unk" | primLang$primary_language=="oth"),]

#Total other/unknown

#total row
unkLang<- as.data.frame(unkLang)
rownames(unkLang) <- unkLang$primary_language
unkLang$primary_language <- unkLang$InEnglish <-NULL
rowsum <-colSums(unkLang)
unkLang <-rbind(unkLang, rowsum)

#row names
rownames(unkLang) <- c("Other Language", "Unknown Language","Total Unknown or Other Language")
```

```{r tab4.1_disp, echo = F, include=T, error=T}

knitr::kable(unkLang[1:3, c('langCnt','langPct')], 
            col.names=     c("Frequency","Percent"), 
            row.names= T, 
            format.args = list(big.mark = ","))


```

## Table 5. Gender Distribution 

```{r gender , echo = F, include=T, error=T}
gender <-   demogCounts %>% 
            group_by(gender) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )
gender <- within(merge(gender,subset(valSets,tableName=='DEMOGRAPHICS' & columnName=='GENDER')[c('code','decode')], by.x='gender', by.y='code', all.x=TRUE) %>% arrange(desc(countPct)) ,{
    decode <- ifelse(!is.na(decode),decode, ifelse(is.na(gender) , 'Missing', 'Invalid'))
})
```

```{r tab5_disp, echo = F, include=T, error=T}
knitr::kable(gender[    c('gender', 'decode','count','countPct')], 
            col.names = c("Value","Label","Frequency","Percent"), row.names=FALSE, 
            format.args = list(big.mark = ","))
```

## Table 5.1. Gender Identity Distribution 

```{r gender_identity , echo = F, include=T, error=T}
gender_identity <-   demogCounts %>% 
            group_by(gender_identity) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )

#total row
gender_identity<- as.data.frame(gender_identity [c(3,2,7,6,5,1,4,8),])
rownames(gender_identity) <- c('Male', 'Female', 'Transgender Male','Transgender Female', 'Other', 'Declined to answer', 'No Information','Unknown ')
gender_identity$gender_identity  <-gender_identity$totCount <-NULL
rowsum <-colSums(gender_identity)
gender_identity <-rbind(gender_identity, rowsum)

#row names
rownames(gender_identity) [9]<- c( 'Total')

gender_identity <- gender_identity %>%
  rownames_to_column((var="Gender Identity"))
```

```{r tab5.1_disp, echo = F, include=T, error=T}
 
knitr::kable(gender_identity[c( 'Gender Identity','count','countPct')], 
            col.names = c('Gender Identity',"Frequency", "Percent"), 
            row.names=F, 
            format.args = list(big.mark = ","))
```


## Table 5.2. Gender Identity by Gender Distribution 

```{r gender_by_gender_identity , echo = F, include=T, error=T} 
tab_gender_identity<- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @GENDER TABLE (GI varchar(2), GENDER_IDENTITYDESC varchar(50));
insert into @GENDER values 
       ('DC', 'Declined to answer')
       ,('F', 'Female')
       ,('M', 'Male')
       ,('NI', 'No information')
       ,('OT', 'Other')
       ,('TM', 'Transgender Male')
       ,('TF', 'Transgender Female')
       ,('UN', 'Unknown');
 
select GENDER_IDENTITYDESC as Gender_Identity,
       (select count(*)
        from %DEMOGRAPHICS%
        where GI in (gender_identity) and
              'M' in (gender)) as 'Male',
       (select count(*)
        from %DEMOGRAPHICS%
        where GI in (gender_identity) and
              'F' in (gender)) as 'Female',
       (select count(*)
        from %DEMOGRAPHICS%
        where GI in (gender_identity) and
              'U' in (gender)) as 'Unknown Gender'
from @GENDER;"))




#Row totals
rownames(tab_gender_identity) <- tab_gender_identity$Gender_Identity
tab_gender_identity$Gender_Identity <- NULL
tab_gender_identity<- tab_gender_identity [c("Male","Female","Transgender Male","Transgender Female","Other","Declined to answer","No information","Unknown"),]
rowsum <-colSums(tab_gender_identity)
tab_gender_identity <-rbind(tab_gender_identity, rowsum)


#Column totals
colsum <-rowSums(tab_gender_identity)
tab_gender_identity <- cbind(tab_gender_identity,colsum)

#Row percents
tab_gender_identity$Percent_Male <- round(tab_gender_identity$Male/(tab_gender_identity$Male+tab_gender_identity$Female)*100, digits=2)

tab_gender_identity$Percent_Female <-round(tab_gender_identity$Female/(tab_gender_identity$Male+tab_gender_identity$Female)*100,
digits=2)                                            



#Renaming for final table
colnames (tab_gender_identity) [4] <- "Total Frequency"
rownames(tab_gender_identity) [9] <- "Total"


tab_gender_identity <- tab_gender_identity %>%
  rownames_to_column((var="Gender Identity"))

```

```{r tab5.2_disp, echo = F, include=T, error=T}

knitr::kable(tab_gender_identity[c('Gender Identity','Male','Percent_Male', 'Female', 'Percent_Female', 'Unknown Gender', 'Total Frequency')], 
            col.names = c('Gender Identity','Male','Percent Male', 'Female', 'Percent Female', 'Unknown Gender', 'Total Frequency'), 
            row.names=F, 
            format.args = list(big.mark = ","))
```

## Table 5.3. Sexual Orientation Distribution 

```{r sexual_orientation , echo = F, include=T, error=T}
sexual_orientation <-   demogCounts %>% 
            group_by(sexual_orientation) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )

#total row
sexual_orientation<- as.data.frame(sexual_orientation [c(1,3,4,5,7,8,9,2,6,10),])
rownames(sexual_orientation) <- c('Bisexual', 'Gay', 'Lesbian','Multiple sexual orientations', 'Questioning', 'Something else', 'straight','Declined to answer','No Information','Unknown ')
sexual_orientation$sexual_orientation  <-sexual_orientation$totCount <-NULL
rowsum <-colSums(sexual_orientation)
sexual_orientation <-rbind(sexual_orientation, rowsum)

#row names
rownames(sexual_orientation) [11]<- c( 'Total')

sexual_orientation <- sexual_orientation %>%
  rownames_to_column((var="Sexual Orientation"))

```

```{r tab5.3_disp, echo = F, include=T, error=T}
knitr::kable(sexual_orientation[c( 'Sexual Orientation','count','countPct')], 
            col.names = c('Sexual Orientation',"Frequency", "Percent"), 
            row.names=F, 
            format.args = list(big.mark = ","))
```

## Table 6. Race Distribution: Race1

```{r race , echo = F, include=T, error=T}
race <-   demogCounts %>% 
            group_by(race1) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )
race <- within(merge(race,subset(valSets,tableName=='DEMOGRAPHICS' & columnName=='RACE1')[c('code','decode')], by.x='race1', by.y='code', all.x=TRUE) %>% arrange(desc(countPct)) ,{
    decode <- ifelse(!is.na(decode),decode, ifelse(is.na(gender) , 'Missing', 'Invalid'))
})
```

```{r tab6_disp, echo = F, include=T, error=T}
knitr::kable(race[    c('race1', 'decode','count','countPct')], 
            col.names = c("Value","Label","Frequency","Percent"), 
            row.names=FALSE, 
            format.args = list(big.mark = ","))
```

## Table 6.2. Race Distribution: Race2

```{r race2 , echo = F, include=T, error=T}
race2 <-   demogCounts %>% 
            group_by(race2) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )
race2 <- within(merge(race2,subset(valSets,tableName=='DEMOGRAPHICS' & columnName=='RACE2')[c('code','decode')], by.x='race2', by.y='code', all.x=TRUE) %>% arrange(desc(countPct)) ,{
    decode <- ifelse(!is.na(decode),decode, ifelse(is.na(gender) , 'Missing', 'Invalid'))
})
```

```{r tab6.2_disp, echo = F, include=T, error=T}
knitr::kable(race2[    c('race2', 'decode','count','countPct')], 
            col.names = c("Value","Label","Frequency","Percent"), 
            row.names=FALSE, 
            format.args = list(big.mark = ","))
```

## Table 6.3. Race Distribution: Race3
```{r race3 , echo = F, include=T, error=T}
race3 <-   demogCounts %>% 
            group_by(race3) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )
race3 <- within(merge(race3,subset(valSets,tableName=='DEMOGRAPHICS' & columnName=='RACE3')[c('code','decode')], by.x='race3', by.y='code', all.x=TRUE) %>% arrange(desc(countPct)) ,{
    decode <- ifelse(!is.na(decode),decode, ifelse(is.na(gender) , 'Missing', 'Invalid'))
})
```

```{r tab6.3_disp, echo = F, include=T, error=T}
knitr::kable(race3[    c('race3', 'decode','count','countPct')], 
            col.names = c("Value","Label","Frequency","Percent"), 
            row.names=FALSE, 
            format.args = list(big.mark = ","))
```


## Table 6.4. Race Distribution: Race4

```{r race4 , echo = F, include=T, error=T}
race4 <-   demogCounts %>% 
            group_by(race4) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )
race4 <- within(merge(race4,subset(valSets,tableName=='DEMOGRAPHICS' & columnName=='RACE4')[c('code','decode')], by.x='race4', by.y='code', all.x=TRUE) %>% arrange(desc(countPct)) ,{
    decode <- ifelse(!is.na(decode),decode, ifelse(is.na(gender) , 'Missing', 'Invalid'))
})
```

```{r tab6.4_disp, echo = F, include=T, error=T}
knitr::kable(race4[    c('race4', 'decode','count','countPct')], 
            col.names = c("Value","Label","Frequency","Percent"), 
            row.names=FALSE, 
            format.args = list(big.mark = ","))
```


## Table 6.5. Race Distribution: Race5
```{r race5 , echo = F, include=T, error=T}
race5 <-   demogCounts %>% 
            group_by(race5) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )
race5 <- within(merge(race5,subset(valSets,tableName=='DEMOGRAPHICS' & columnName=='RACE5')[c('code','decode')], by.x='race5', by.y='code', all.x=TRUE) %>% arrange(desc(countPct)) ,{
    decode <- ifelse(!is.na(decode),decode, ifelse(is.na(gender) , 'Missing', 'Invalid'))
})
```

```{r tab6.5_disp, echo = F, include=T, error=T}
knitr::kable(race5[    c('race5', 'decode','count','countPct')], 
            col.names = c("Value","Label","Frequency","Percent"), 
            row.names=FALSE, 
            format.args = list(big.mark = ","))
```



## Table 6.6. Race1 by Race2 Bivariate Distribution
```{r race1xrace2_alt , echo = F, include=T, error=T}
 
tab_race1race2 <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACES TABLE (RACE varchar(2), RACEDESC varchar(50));
insert into @RACES values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race1Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'AS' in (Race2)) as 'Asian',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'BA' in (Race2)) as 'Black or African American',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'HP' in (Race2)) as 'Native Hawaiian or Other Pacific Islander',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'IN' in (Race2)) as 'American Indian/Alaska Native',
       (select count(*)
        from %DEMOGRAPHICS%
        where (RACE in (Race1) OR Race1 IS NULL) and
              ('UN' in (Race2) OR Race2 IS NULL)) as 'Unknown or Not Reported',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'WH' in (Race2)) as 'White'
from @RACES;"))

#Row totals
rownames(tab_race1race2) <- tab_race1race2$Race1Group
tab_race1race2$Race1Group <- NULL
rowsum <-colSums(tab_race1race2)
tab_race1race2 <-rbind(tab_race1race2, rowsum)


#Column totals
colsum <-rowSums(tab_race1race2)
tab_race1race2 <- cbind(tab_race1race2,colsum)

#Renaming for final table
colnames (tab_race1race2) [7] <- "Total"
rownames(tab_race1race2) [7] <- "Total"


tab_race1race2 <- tab_race1race2 %>%
  rownames_to_column((var="Race Group"))
```

```{r tab6.6_disp, echo = F, include=T, error=T}
knitr::kable(tab_race1race2,
             format.args = list(big.mark = ","))

```

## Table 6.7. Race1 by Race3 Bivariate Distribution
```{r race1xrace3 , echo = F, include=T, error=T}

tab_race1race3 <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACES TABLE (RACE varchar(2), RACEDESC varchar(50));
insert into @RACES values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race1Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'AS' in (Race3)) as 'Asian',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'BA' in (Race3)) as 'Black or African American',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'HP' in (Race3)) as 'Native Hawaiian or Other Pacific Islander',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'IN' in (Race3)) as 'American Indian/Alaska Native',
       (select count(*)
        from %DEMOGRAPHICS%
        where (RACE in (Race1) OR Race1 IS NULL) and
              ('UN' in (Race3) OR Race2 IS NULL)) as 'Unknown or Not Reported',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'WH' in (Race3)) as 'White'
from @RACES;"))

#Row totals
rownames(tab_race1race3) <- tab_race1race3$Race1Group
tab_race1race3$Race1Group <- NULL
rowsum <-colSums(tab_race1race3)
tab_race1race3 <-rbind(tab_race1race3, rowsum)


#Column totals
colsum <-rowSums(tab_race1race3)
tab_race1race3 <- cbind(tab_race1race3,colsum)

#Renaming for final table
colnames (tab_race1race3) [7] <- "Total"
rownames(tab_race1race3) [7] <- "Total"


tab_race1race3 <- tab_race1race3 %>%
  rownames_to_column((var="Race Group"))
```

```{r tab6.7_disp, echo = F, include=T, error=T}
knitr::kable(tab_race1race3,
             format.args = list(big.mark = ","))
```



## Table 6.8. Race1 by Race4 Bivariate Distribution
```{r race1xrace4 , echo = F, include=T, error=T}

tab_race1race4 <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACES TABLE (RACE varchar(2), RACEDESC varchar(50));
insert into @RACES values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race1Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'AS' in (Race4)) as 'Asian',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'BA' in (Race4)) as 'Black or African American',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'HP' in (Race4)) as 'Native Hawaiian or Other Pacific Islander',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'IN' in (Race4)) as 'American Indian/Alaska Native',
       (select count(*)
        from %DEMOGRAPHICS%
        where (RACE in (Race1) OR Race1 IS NULL) and
              ('UN' in (Race4) OR Race2 IS NULL)) as 'Unknown or Not Reported',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'WH' in (Race4)) as 'White'
from @RACES;"))

#Row totals
rownames(tab_race1race4) <- tab_race1race4$Race1Group
tab_race1race4$Race1Group <- NULL
rowsum <-colSums(tab_race1race4)
tab_race1race4 <-rbind(tab_race1race4, rowsum)


#Column totals
colsum <-rowSums(tab_race1race4)
tab_race1race4 <- cbind(tab_race1race4,colsum)

#Renaming for final table
colnames (tab_race1race4) [7] <- "Total"
rownames(tab_race1race4) [7] <- "Total"


tab_race1race4 <- tab_race1race4 %>%
  rownames_to_column((var="Race Group"))
```

```{r tab6.8_disp, echo = F, include=T, error=T}
knitr::kable(tab_race1race4,
             format.args = list(big.mark = ","))

```


## Table 6.9. Race1 by Race5 Bivariate Distribution

```{r race1xrace5 , echo = F, include=T, error=T}

tab_race1race5 <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACES TABLE (RACE varchar(2), RACEDESC varchar(50));
insert into @RACES values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race1Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'AS' in (Race5)) as 'Asian',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'BA' in (Race5)) as 'Black or African American',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'HP' in (Race5)) as 'Native Hawaiian or Other Pacific Islander',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'IN' in (Race5)) as 'American Indian/Alaska Native',
       (select count(*)
        from %DEMOGRAPHICS%
        where (RACE in (Race1) OR Race1 IS NULL) and
              ('UN' in (Race5) OR Race2 IS NULL)) as 'Unknown or Not Reported',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'WH' in (Race5)) as 'White'
from @RACES;"))

#Row totals
rownames(tab_race1race5) <- tab_race1race5$Race1Group
tab_race1race5$Race1Group <- NULL
rowsum <-colSums(tab_race1race5)
tab_race1race5 <-rbind(tab_race1race5, rowsum)


#Column totals
colsum <-rowSums(tab_race1race5)
tab_race1race5 <- cbind(tab_race1race5,colsum)

#Renaming for final table
colnames (tab_race1race5) [7] <- "Total"
rownames(tab_race1race5) [7] <- "Total"


tab_race1race5 <- tab_race1race5 %>%
  rownames_to_column((var="Race Group"))
```

```{r tab6.9_disp, echo = F, include=T, error=T}
knitr::kable(tab_race1race5,
             format.args = list(big.mark = ","))
```

## Table 7. Hispanic Ethnicity Distribution

```{r ethnicity , echo = F, include=T, error=T}

ethn <- odbc::dbGetQuery(con, 
  paste0("SELECT SUM(CASE WHEN HISPANIC = 'Y' THEN 1 ELSE 0 END) as Yes,
   SUM(CASE WHEN HISPANIC = 'N' THEN 1 ELSE 0 END) as No,
   SUM(CASE WHEN HISPANIC = 'U' THEN 1 ELSE 0 END) as Unknown
      FROM ", demographics))
ethn2 <- data.frame(Value = c("Y", "N", "U"),
                    Label = names(ethn), 
                    Frequency = c(ethn$Yes, ethn$No, ethn$Unknown), 
                    Percent = c((ethn$Yes/tab1_dem$npats * 100), (ethn$No/tab1_dem$npats * 100), (ethn$Unknown/tab1_dem$npats * 100)))
```

```{r tab7_disp, echo = F, include=T, error=T}
knitr::kable(ethn2, digits = 2,
            format.args = list(big.mark = ","))
```


## Table 7.1. Race by Hispanic Ethnicity Distribution
```{r race1xethnicity , echo = F, include=T, error=T}
tab_race1hispanic <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACETHN TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACETHN values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race1Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where RACE in (Race1) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
from @RACETHN;"))

#Row totals
rownames(tab_race1hispanic) <- tab_race1hispanic$Race1Group
tab_race1hispanic$Race1Group <- NULL
rowsum <-colSums(tab_race1hispanic)
tab_race1hispanic <-rbind(tab_race1hispanic, rowsum)


#Column totals
colsum <-rowSums(tab_race1hispanic)
tab_race1hispanic <- cbind(tab_race1hispanic,colsum)

#Renaming for final table
colnames (tab_race1hispanic) [4] <- "Total"
rownames(tab_race1hispanic) [7] <- "Total"

tab_race1hispanic <- tab_race1hispanic %>%
  rownames_to_column((var="Race1 Group"))
```

```{r tab7.1_disp, echo = F, include=T, error=T}
knitr::kable(tab_race1hispanic,
             format.args = list(big.mark = ","))
```             

## Table 7.2. Race2 by Hispanic Ethnicity where Race1 is Unknown

```{r race2xethnicity , echo = F, include=T, error=T}

tab_race2hispanic <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACETHN TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACETHN values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race2Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race2) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race2) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race2) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACETHN;"))              
              
     

#Row totals
rownames(tab_race2hispanic) <- tab_race2hispanic$Race2Group
tab_race2hispanic$Race2Group <- NULL
rowsum <-colSums(tab_race2hispanic)
tab_race2hispanic <-rbind(tab_race2hispanic, rowsum)


#Column totals
colsum <-rowSums(tab_race2hispanic)
tab_race2hispanic <- cbind(tab_race2hispanic,colsum)

#Renaming for final table
colnames (tab_race2hispanic) [4] <- "Total"
rownames(tab_race2hispanic) [7] <- "Total"

tab_race2hispanic <- tab_race2hispanic %>%
  rownames_to_column((var="Race2 Group"))
```

```{r tab7.2_disp, echo = F, include=T, error=T}
knitr::kable(tab_race2hispanic,
             format.args = list(big.mark = ","))
```        

## Table 7.3. Race3 by Hispanic Ethnicity where Race1 is Unknown

```{r race3xethnicity , echo = F, include=T, error=T}

tab_race3hispanic <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACETHN TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACETHN values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race3Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race3) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race3) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race3) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACETHN;"))              
              
     

#Row totals
rownames(tab_race3hispanic) <- tab_race3hispanic$Race3Group
tab_race3hispanic$Race3Group <- NULL
rowsum <-colSums(tab_race3hispanic)
tab_race3hispanic <-rbind(tab_race3hispanic, rowsum)


#Column totals
colsum <-rowSums(tab_race3hispanic)
tab_race3hispanic <- cbind(tab_race3hispanic,colsum)

#Renaming for final table
colnames (tab_race3hispanic) [4] <- "Total"
rownames(tab_race3hispanic) [7] <- "Total"

tab_race3hispanic <- tab_race3hispanic %>%
  rownames_to_column((var="Race3 Group"))
```

```{r tab7.3_disp, echo = F, include=T, error=T}
knitr::kable(tab_race3hispanic,
             format.args = list(big.mark = ","))
```        


## Table 7.4. Race4 by Hispanic Ethnicity where Race1 is Unknown

```{r race4xethnicity , echo = F, include=T, error=T}

tab_race4hispanic <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACETHN TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACETHN values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race4Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race4) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race4) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race4) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACETHN;"))              
              
     

#Row totals
rownames(tab_race4hispanic) <- tab_race4hispanic$Race4Group
tab_race4hispanic$Race4Group <- NULL
rowsum <-colSums(tab_race4hispanic)
tab_race4hispanic <-rbind(tab_race4hispanic, rowsum)


#Column totals
colsum <-rowSums(tab_race4hispanic)
tab_race4hispanic <- cbind(tab_race4hispanic,colsum)

#Renaming for final table
colnames (tab_race4hispanic) [4] <- "Total"
rownames(tab_race4hispanic) [7] <- "Total"

tab_race4hispanic <- tab_race4hispanic %>%
  rownames_to_column((var="Race4 Group"))
```

```{r tab7.4_disp, echo = F, include=T, error=T}
knitr::kable(tab_race4hispanic,
             format.args = list(big.mark = ","))
```        

## Table 7.5. Race5 by Hispanic Ethnicity where Race1 is Unknown

```{r race5xethnicity , echo = F, include=T, error=T}

tab_race5hispanic <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACETHN TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACETHN values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race5Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race5) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race5) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Race1='UN' and RACE in (Race5) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACETHN;"))              
              
     

#Row totals
rownames(tab_race5hispanic) <- tab_race5hispanic$Race5Group
tab_race5hispanic$Race5Group <- NULL
rowsum <-colSums(tab_race5hispanic)
tab_race5hispanic <-rbind(tab_race5hispanic, rowsum)


#Column totals
colsum <-rowSums(tab_race5hispanic)
tab_race5hispanic <- cbind(tab_race5hispanic,colsum)

#Renaming for final table
colnames (tab_race5hispanic) [4] <- "Total"
rownames(tab_race5hispanic) [7] <- "Total"

tab_race5hispanic <- tab_race5hispanic %>%
  rownames_to_column((var="Race5 Group"))
```

```{r tab7.5_disp, echo = F, include=T, error=T}
knitr::kable(tab_race5hispanic,
             format.args = list(big.mark = ","))
```

## Table 7.6. Race1 by Hispanic Ethnicity where Primary Language is Spanish

```{r race1xethnicityxlang , echo = F, include=T, error=T}

tab_race1lang <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACELANG TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACELANG values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race1Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race1) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race1) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race1) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACELANG;"))              
              
     

#Row totals
rownames(tab_race1lang) <- tab_race1lang$Race1Group
tab_race1lang$Race1Group <- NULL
rowsum <-colSums(tab_race1lang)
tab_race1lang <-rbind(tab_race1lang, rowsum)


#Column totals
colsum <-rowSums(tab_race1lang)
tab_race1lang <- cbind(tab_race1lang,colsum)

#Renaming for final table
colnames (tab_race1lang) [4] <- "Total"
rownames(tab_race1lang) [7] <- "Total"

tab_race1lang <- tab_race1lang %>%
  rownames_to_column((var="Race1 Group"))
```

```{r tab7.6_disp, echo = F, include=T, error=T}
knitr::kable(tab_race1lang,
             format.args = list(big.mark = ","))
```   

## Table 7.7. Race2 by Hispanic Ethnicity where Primary Language is Spanish

```{r race2xethnicityxlang , echo = F, include=T, error=T}
tab_race2lang <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACELANG TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACELANG values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race2Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race2) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race2) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race2) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACELANG;"))              
              
     

#Row totals
rownames(tab_race2lang) <- tab_race2lang$Race2Group
tab_race2lang$Race2Group <- NULL
rowsum <-colSums(tab_race2lang)
tab_race2lang <-rbind(tab_race2lang, rowsum)


#Column totals
colsum <-rowSums(tab_race2lang)
tab_race2lang <- cbind(tab_race2lang,colsum)

#Renaming for final table
colnames (tab_race2lang) [4] <- "Total"
rownames(tab_race2lang) [7] <- "Total"

tab_race2lang <- tab_race2lang %>%
  rownames_to_column((var="Race2 Group"))
```

```{r tab7.7_disp, echo = F, include=T, error=T}
knitr::kable(tab_race2lang,
             format.args = list(big.mark = ","))
```   

## Table 7.8. Race3 by Hispanic Ethnicity where Primary Language is Spanish

```{r race3xethnicityxlang , echo = F, include=T, error=T}
tab_race3lang <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACELANG TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACELANG values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race3Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race3) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race3) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race3) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACELANG;"))              
              
     

#Row totals
rownames(tab_race3lang) <- tab_race3lang$Race3Group
tab_race3lang$Race3Group <- NULL
rowsum <-colSums(tab_race3lang)
tab_race3lang <-rbind(tab_race3lang, rowsum)


#Column totals
colsum <-rowSums(tab_race3lang)
tab_race3lang <- cbind(tab_race3lang,colsum)

#Renaming for final table
colnames (tab_race3lang) [4] <- "Total"
rownames(tab_race3lang) [7] <- "Total"

tab_race3lang <- tab_race3lang %>%
  rownames_to_column((var="Race3 Group"))
```

```{r tab7.8_disp, echo = F, include=T, error=T}
knitr::kable(tab_race3lang,
             format.args = list(big.mark = ","))
```   

## Table 7.9. Race4 by Hispanic Ethnicity where Primary Language is Spanish

```{r race4xethnicityxlang , echo = F, include=T, error=T}
tab_race4lang <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACELANG TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACELANG values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race4Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race4) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race4) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race4) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACELANG;"))              
              
     

#Row totals
rownames(tab_race4lang) <- tab_race4lang$Race4Group
tab_race4lang$Race4Group <- NULL
rowsum <-colSums(tab_race4lang)
tab_race4lang <-rbind(tab_race4lang, rowsum)


#Column totals
colsum <-rowSums(tab_race4lang)
tab_race4lang <- cbind(tab_race4lang,colsum)

#Renaming for final table
colnames (tab_race4lang) [4] <- "Total"
rownames(tab_race4lang) [7] <- "Total"

tab_race4lang <- tab_race4lang %>%
  rownames_to_column((var="Race4 Group"))
```

```{r tab7.9_disp, echo = F, include=T, error=T}
knitr::kable(tab_race4lang,
             format.args = list(big.mark = ","))
```   

## Table 7.10. Race5 by Hispanic Ethnicity where Primary Language is Spanish

```{r race5xethnicityxlang , echo = F, include=T, error=T}
tab_race5lang <- DBI::dbGetQuery(con, gsub("%DEMOGRAPHICS%", demographics, "
SET NOCOUNT ON;
declare @RACELANG TABLE (RACE varchar(2),  RACEDESC varchar(50));
insert into @RACELANG values 
       ('AS', 'Asian')
       ,('BA', 'Black or African American')
       ,('HP', 'Native Hawaiian or Other Pacific Islander')
       ,('IN', 'American Indian/Alaska Native')
       ,('UN', 'Unknown or Not Reported')
       ,('WH', 'White');
 
select RACEDESC as Race5Group,
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race5) and
              'Y' in (Hispanic)) as 'Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race5) and
              'N' in (Hispanic)) as 'Non-Hispanic',
       (select count(*)
        from %DEMOGRAPHICS%
        where Primary_Language='spa' and RACE in (Race5) and
              'U' in (Hispanic)) as 'Unknown Hispanic'
               
from @RACELANG;"))              
              
     

#Row totals
rownames(tab_race5lang) <- tab_race5lang$Race5Group
tab_race5lang$Race5Group <- NULL
rowsum <-colSums(tab_race5lang)
tab_race5lang <-rbind(tab_race5lang, rowsum)


#Column totals
colsum <-rowSums(tab_race5lang)
tab_race5lang <- cbind(tab_race5lang,colsum)

#Renaming for final table
colnames (tab_race5lang) [4] <- "Total"
rownames(tab_race5lang) [7] <- "Total"

tab_race5lang <- tab_race5lang %>%
  rownames_to_column((var="Race5 Group"))
```

```{r tab7.10_disp, echo = F, include=T, error=T}
knitr::kable(tab_race5lang,
             format.args = list(big.mark = ","))
```   


## Table 7.11. Unknown or Missing Race1 and Hispanic Ethnicity Over Time

```{r missing race/ethnicity over time, include=FALSE}


# create a temp table in the SQL DB temp drive, this will not be pulled into the R workspace.This pulls in the most recent encounter date and combines it with race and hispanic data from demographics

encTmp1 <-   sqlQuery(sqldb,
                  paste('SELECT d.*, demo.RACE1, demo.HISPANIC ',
                                         'INTO #encTmp1 ',
                                         'FROM (',
                                         'SELECT a.PERSON_ID, max(adate) as lastEnc',
                        'FROM ',encounters, ' as a inner join (select distinct person_id  from  ',demographics,') as b on a.person_id = b.person_id group by a.PERSON_ID) as d',
                        'inner join ',demographics,' demo on demo.PERSON_ID = d.PERSON_ID',
                                         sep=" "
                        )
                  )


tab7.11_rowCnt <-sqlQuery(sqldb,
                 paste("SELECT year(lastEnc) as year, count(*) as rowCnt",
                       "FROM #encTmp1 where Race1 in ('UN') and Hispanic in ('U') GROUP BY year(lastEnc)",
                       sep=" "
                       )
                )

tab7.11_totalCnt <-sqlQuery(sqldb,
                 paste("SELECT year(lastEnc) as year, count(*) as rowCnt",
                       "FROM #encTmp1 GROUP BY year(lastEnc)",
                       sep=" "
                       )
                )

tab7.11_combined <- data.frame(cbind(tab7.11_rowCnt, tab7.11_totalCnt$rowCnt))

tab7.11_combined$rowPct <- round(100*tab7.11_combined$rowCnt/tab7.11_combined$tab7.11_totalCnt.rowCnt,1)
tab7.11_combined$year <- as.character(tab7.11_combined$year)
```

```{r tab7.11_disp, echo = F, include=T, error=T}
knitr::kable(tab7.11_combined[    c('year', 'rowCnt','tab7.11_totalCnt.rowCnt','rowPct')], 
            col.names = c("Year","Frequency Unknown Race1 and Hispanic","Total Frequency","Percent Missing Race1 and Hispanic"), row.names=FALSE, 
            format.args = list(big.mark = ","), align = 'c')
```   
  
## Figure 1. Percent of Patients with Unknown Race1 and Hispanic Values by Year

```{r tab7.11_fig, echo = F, include=T, error=T}

ggplot(data = tab7.11_combined, aes(x = year, y = rowPct, group=1)) + geom_line() + geom_point() + ylab("Percent") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


## Table 7.12. Unknown or Missing Race1 and Hispanic Ethnicity by Gender

```{r missing race/ethnicity by gender, include=FALSE}
gender_re <- demogCounts[ which (demogCounts$race1=='UN' & demogCounts$hispanic=='U'),]

gender_re <-   demogCounts  %>% 
            group_by(gender) %>% 
            summarise(count = sum(nRows)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )

gender_re <- within(merge(gender_re,subset(valSets,columnName=='GENDER')[c('code','decode')], by.x='gender', by.y='code', all.x=TRUE) %>% arrange(desc(countPct)) ,{
    decode <- ifelse(!is.na(decode),decode, ifelse(is.na(gender) , 'Missing', 'Invalid'))
})
```

```{r tab7.12_disp, echo = F, include=T, error=T}
knitr::kable(gender_re[    c('gender', 'decode','count','countPct')], 
            col.names = c("Value","Label","Frequency","Percent"), row.names=FALSE, 
            format.args = list(big.mark = ","))
```




## Table 7.13. Unknown or Missing Race1 and Hispanic Ethnicity by Age Group

```{r missing race/ethnicity by age, include=FALSE}

encTmp2 <- sqlQuery(sqldb,
                  paste('SELECT D.*,   demo.RACE1, demo.HISPANIC, demo.birth_date ',
                                         'INTO #encTmp10 ',
                                         'FROM (',
                                         'SELECT a.PERSON_ID, max(adate) as lastEnc, floor(DATEDIFF(day, b.BIRTH_DATE, A.adate)/365.25) as age',
                        'FROM ',encounters, ' as a inner join (select distinct person_id, birth_date  from  ',demographics,') as b on a.person_id = b.person_id group by a.PERSON_ID, a.adate, b.birth_date) as d',
                        'inner join ',demographics,' demo on demo.PERSON_ID = d.PERSON_ID',
                                         sep=" "
                        )
                  )

tab7.13_rowCnt <- sqlQuery(sqldb,
                 paste("SELECT ageBase.age,
                          CASE
                            WHEN ageSubGroup.rowCnt IS NULL THEN 0 ELSE ageSubGroup.rowCnt END AS rowCnt
                          FROM (SELECT age, 
                                  COUNT(*) AS rowCnt
                                  FROM #encTmp10
                                  GROUP BY age) ageBase
                          LEFT JOIN (SELECT age, 
                                        COUNT(*) AS rowCnt
                                        FROM #encTmp10
                                        WHERE  Race1 IN('UN')
                                        AND Hispanic IN('U')
                                        GROUP BY age) ageSubGroup ON ageSubGroup.age = ageBase.age
                          ORDER BY age;",
                       sep=" "
                       )
                )

tab7.13_rowCnt$ageCat <- ageCatCalc(as.numeric(tab7.13_rowCnt$age))


tab7.13_rowCnt <-   tab7.13_rowCnt  %>% 
            group_by(ageCat) %>% 
            summarise(count = sum(rowCnt)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  columnPct = round(100*count/totCount,1)
                  )


tab7.13_total <- sqlQuery(sqldb,
                 paste("SELECT age, count(*) as rowCnt",
                       "FROM #encTmp10  GROUP BY age ",
                       sep=" "
                       )
                )

tab7.13_total$ageCat <- ageCatCalc(as.numeric(tab7.13_total$age))


tab7.13_total <-   tab7.13_total  %>% 
            group_by(ageCat) %>% 
            summarise(count = sum(rowCnt)) %>% 
            ungroup()  %>% 
            mutate(totCount = sum(count), 
                  countPct = round(100*count/totCount,1)
                  )


tab7.13_combined <- data.frame(cbind(tab7.13_rowCnt, tab7.13_total$count))


tab7.13_combined$rowPct <- round(100*tab7.13_combined$count/tab7.13_combined$tab7.13_total.count,1)


```

```{r tab7.13_disp, echo = F, include=T, error=T}
knitr::kable(tab7.13_combined[    c('ageCat', 'count','tab7.13_total.count','columnPct', 'rowPct')], 
            col.names = c("Age Group","Frequency Missing Race1 & Hispanic","Total Frequency","Column Percent", "Row Percent"), row.names=FALSE, 
            format.args = list(big.mark = ","))
```



```{r encounter table, include=FALSE}
rm(diag)
gc()
# create a temp table in the SQL DB temp drive, this will not be pulled into the R workspace.
nada_ <- sqlQuery(sqldb,
                  paste('SELECT a.*, floor(DATEDIFF(day, b.birth_date, a.ADATE)/365.25) as age, b.birth_date, month(a.adate) as aMon, year(a.adate) as aYear, month(b.birth_date) as dobMon, year(b.birth_date) as dobYear',
                        'INTO #encTmp',
                        'FROM ',encounters, ' as a left join (select distinct person_id, birth_date from  ',demographics,') as b on a.person_id = b.person_id',
                        sep=" "
                        )
                  )



# short labels for encounter type 

encLabels <- data.frame(c('AV','ED','EM','IP','IS','LO','OE','RO', 'TE'),
                        c('Ambulatory Visit','Emergency Department', 'E-mail', 'Acute Inpatient','Institutional Stay','Lab only','Other','Radiology only', 'Telephone' ) ,
                        stringsAsFactors = F
)
names(encLabels)<-c('code','decode')
# overall enc summary
# read encounter table
encSumm  <- sqlQuery(sqldb,
                 paste('SELECT count(*) as rowCnt, count(distinct enc_id) as encCnt, count(distinct person_id) as personCnt, min(adate) as firstEnc, max(adate) as lastEnc',
                       'FROM #encTmp',
                       sep=" "
                       ),
                 as.is=c(TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE),
                 max=maxQryRows
                 )
encRows <- encSumm$rowCnt
encPrimKeyRows <- encSumm$encCnt
nEncPats <- encSumm$personCnt
```






## Examination of the ENCOUNTERS Table

Total rows in the dataset: `r encRows`

Total unique combinations of the primary key: `r encPrimKeyRows `

Total patients in the encounter table: `r nEncPats`

Month and year of first encounter: `r format(as.Date(encSumm$firstEnc),"%B %Y")`

Month and year of last encounter: `r format(as.Date(encSumm$lastEnc),"%B %Y")`

`r ifelse(encRows== encPrimKeyRows," ","The encounter table has duplicate rows, by enc_id")`


## Table 8. Count of Distinct Patients by Age Group and Year of Utilization

```{r tab8, echo = F, include=T, error=T}
 
# encPersonYear  <- sqlQuery(sqldb,
#                  paste('SELECT aMon, aYear, dobMon, dobYear, count(*) as personCnt',
#                        'FROM (SELECT distinct person_id, aYear, dobMon, dobYear, min(aMon) as aMon ',
#                        '      FROM #encTmp',
#                        '      GROUP BY person_id, aYear, dobMon, dobYear) as qry',
#                        'GROUP BY  aMon, aYear, dobMon, dobYear',
#                        sep=" "
#                        ),
#                  as.is=c(TRUE,TRUE,TRUE,TRUE,TRUE),
#                  max=maxQryRows
#                  )
encPersonYear  <- sqlQuery(sqldb,
                 paste('SELECT aMon, aYear, age, count(*) as personCnt',
                       'FROM (SELECT distinct person_id, aYear, min(age) as age, min(aMon) as aMon ',
                       '      FROM #encTmp',
                       '      GROUP BY person_id, aYear) as qry',
                       'GROUP BY  aMon, aYear, age',
                       sep=" "
                       ),
                 as.is=c(TRUE,TRUE,TRUE,TRUE,TRUE),
                 max=maxQryRows
                 )
encPersonAgeYear <- within(encPersonYear,{
                           adate_YM <- as.Date(paste(as.character(aYear),as.character(aMon),'01',sep='-'))
                           #dob_YM <- as.Date(paste(as.character(dobYear),as.character(dobMon),'01',sep='-'))
                           #age <- as.numeric(floor((difftime(adate_YM, dob_YM, units='days'))/365.25))
                           ageCat <- ageCatCalc(as.numeric(age))
                    }) %>% 
                    group_by(aYear, ageCat) %>%
                    summarise(Freq = sum(personCnt)) %>% 
                    group_by(aYear) %>%
                    mutate(yearTot = sum(Freq),
                           pct = round(100*Freq/yearTot,1),
                           toDisplay = paste0(Freq,' (',pct,')')
                           )  
 


encPersonAgeYear <- within(encPersonYear,{
                           adate_YM <- as.Date(paste(as.character(aYear),as.character(aMon),'01',sep='-'))
                           #dob_YM <- as.Date(paste(as.character(dobYear),as.character(dobMon),'01',sep='-'))
                           #age <- as.numeric(floor((difftime(adate_YM, dob_YM, units='days'))/365.25))
                           ageCat <- ageCatCalc(as.numeric(age))
                    }) %>% 
                    group_by(aYear, ageCat) %>%
                    summarise(Freq = sum(personCnt)) %>% 
                    group_by(aYear) %>%
                    mutate(yearTot = sum(Freq),
                           pct = round(100*Freq/yearTot,1))

encPersonAgeYear$Freq <- format(encPersonAgeYear$Freq, big.mark = ",")
encPersonAgeYear$toDisplay = paste0(encPersonAgeYear$Freq,' (',encPersonAgeYear$pct,')')
                           


# transpose to square table
encPersonAgeYear_tx <- spread(encPersonAgeYear[c('ageCat','aYear','toDisplay')],aYear,toDisplay)
```

```{r tab8_disp, echo = F, include=T, error=T}
knitr::kable(encPersonAgeYear_tx, 
             col.names=c("Age at First Encounter in CY, N(%)",names(encPersonAgeYear_tx)[-1]), 
             row.names=FALSE, align = "c",
             format.args = list(big.mark = ","))
```


Percentages are calculated with all patients within the calendar year as the denominator

## Figure 2. Count of Distinct Patients by Age Group and Year of Utilization

```{r fig2, echo = F, include=T, error=T}
ggplot(data = encPersonAgeYear, aes(x =aYear, y = Freq, fill = ageCat)) + 
    geom_bar(stat = "identity") + labs(y='Count', x='Year', fill='Age at encounter')+theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Table 9. Annual Trends in the Total Number of Recorded Encounters, the Mean Number of Encounters, the Mean Number of Patients and the Percent Change from the Previous Year, by Calendar Year

```{r tab9_res, echo = F, include=T, error=T}
tab9 <- odbc::dbGetQuery(con, 
  paste0("select year(adate) as year,
    count(*) as nrows, 
	  count(distinct person_id) as npats
	  from ", encounters, "
	    group by year(adate)
      order by year(adate)"))
tab9_avg_pats <- odbc::dbGetQuery(con, 
  paste0("select year(adate) as year,
    count(*) as nrows
	  from ", encounters, "
	    group by year(adate), person_id
      order by year(adate)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(list(mean = mean, median = median, min = min, max = max))%>% 
  mutate(
    pats_val = paste0(median, "(", min, ", ", max, ")")
  )
tab9_all <- left_join(tab9, tab9_avg_pats, by = "year") %>% 
  mutate(
    ptc_rec = if_else(is.na(nrows / dplyr::lag(nrows)), "--", paste0(round(nrows / dplyr::lag(nrows) * 100, 0), "%"))
  ) %>% 
  select(year, nrows, ptc_rec, npats, pats_val)
tab9_all$year <- as.character(tab9_all$year)
```

```{r tab9_dis, echo = F, include=T, error=T}
kable(tab9_all, col.names = c("Year", "Total Number of Recorded Encounters", "Percent Change from Previous Year", "Total Number of Patients with at Least One Encounter", "Median Number of Encounters per Patient (Min, Max)"), format.args = list(big.mark = ","))
```


```{r encounter types by year and month, include=F}
encEncType_YM  <- sqlQuery(sqldb,
                 paste('SELECT aMon, aYear, encType, count(*) as rowCnt',
                       'FROM #encTmp',
                       'GROUP BY aMon, aYear, encType',
                       sep=" "
                       ),
                 as.is=c(TRUE,TRUE,TRUE,TRUE,TRUE),
                 max=maxQryRows
                 )
encEncType_YM <- within(encEncType_YM,{
               adate_YM <- as.Date(paste(as.character(aYear),as.character(aMon),'01',sep='-'))
})
```


## Table 10. Count of Encounters by Encounter Type 

```{r tab10, echo = F, include=T, error=T}
encEncType <- encEncType_YM %>% group_by(encType) %>% summarize(Freq = sum(rowCnt))
encEncType <- merge(encEncType,subset(valSets,tableName=='ENCOUNTERS' & columnName=='ENCTYPE')[c('code','decode')], by.x='encType', by.y='code', all.x=TRUE) 
encEncType <- within(encEncType, {
                            pct <- round(100*Freq/sum(Freq),1)
                           # validVal <- ifelse(is.na(decode),'No','Yes')
                            decode <- ifelse(!is.na(decode),decode, ifelse(is.na(encType), 'Missing', 'Invalid'))
                            })[c('encType','decode','Freq','pct')]
encEncType <- encEncType %>% 
  select(-encType)
```

```{r tab10_disp, echo = F, include=T, error=T}
knitr::kable(encEncType, col.names=c("Encounter Type",'Number of Encounters','Percent of Total Encounters'), 
             row.names=FALSE, 
             format.args = list(big.mark = ","))
```


```{r include=F, error=T}
encByYear <- encEncType_YM %>% group_by(aYear ) %>% summarize(Freq = sum(rowCnt))
encByYear <- within(encByYear,{
                    pct <- round(100*Freq/sum(Freq),1)
 })
encByYear$pctChng <- NA
 for(i in 2:nrow(encByYear)){
   encByYear$pctChng[i]<-
    round(100*(encByYear$Freq[i]-encByYear$Freq[i-1])/encByYear$Freq[i-1],1)
 }
encByYear$aYear <- as.character(encByYear$aYear)
```


```{r  include=F}
uniqPatByYear <- sqlQuery(sqldb,
                 paste('SELECT aYear, count(distinct person_id) as Freq',
                       'FROM #encTmp',
                       'GROUP BY aYear',
                       sep=" "
                       ),
                 as.is=c(TRUE,TRUE,TRUE,TRUE,TRUE),
                 max=maxQryRows
                 )
uniqPatByYear <- within(uniqPatByYear,{
                    pct <- round(100*Freq/sum(Freq),1)
 })
uniqPatByYear$pctChng<-NA
for(i in 2:nrow(uniqPatByYear)){
   uniqPatByYear$pctChng[i]<- round(100*(uniqPatByYear$Freq[i]-uniqPatByYear$Freq[i-1])/uniqPatByYear$Freq[i-1],1)
 }
uniqPatByYear$aYear <- as.character(uniqPatByYear$aYear)
```


```{r add labels to encEncType_YM , include=F}
encTypeBymonYr <- merge(encEncType_YM,encLabels, by.x='encType', by.y='code', all.x=TRUE) 
encTypeBymonYr <- within(encTypeBymonYr,{decode <- ifelse(!is.na(decode),decode, ifelse(is.na(encType), 'Missing', 'Invalid'))})
```



## Figure 3a. Ambulatory Encounters by Admission Year and Month

```{r fig3a, echo = F, include=T, error=T}
ggplot(subset(encTypeBymonYr,encType == 'AV'), aes(adate_YM, rowCnt)) + geom_line() +
  scale_x_date(date_labels = "%b %y",date_breaks='1 year') + xlab("Month of encounter") + ylab("Frequency")+theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Figure 3b. Other Encounter Types by Admission Year and Month

```{r fig3b, echo = F, include=T, error=T}
ggplot(subset(encTypeBymonYr,encType != 'AV'), aes(adate_YM, rowCnt, colour=decode)) + geom_line() +
  scale_x_date(date_labels = "%b %y",date_breaks='1 year') + xlab("Month of encounter") + ylab("Frequency")+theme(axis.text.x = element_text(angle = 45, hjust = 1))+labs(color='Encounter type')
#,legend.position="bottom" "
```

 
```{r include=F}
#
# Encounter types by year
#
encTypeByYr <- encEncType_YM %>% group_by(encType, aYear ) %>% summarize(Freq = sum(rowCnt))
encTypeByYr <- merge(encTypeByYr,encLabels, by.x='encType', by.y='code', all.x=TRUE) 
encTypeByYr <- within(encTypeByYr,{decode <- ifelse(!is.na(decode),decode, ifelse(is.na(encType), 'Missing', 'Invalid'))})
```


## Examination of the CENSUS_LOCATION Table

```{r census location, echo = F, include=T, error=T}
locSumm  <- sqlQuery(sqldb,
                 paste('SELECT count(*) as rowCnt, COUNT(DISTINCT person_id+CAST(loc_start AS varchar(10)) ) as primKeyCnt, count(distinct person_id) as personCnt, min(loc_start) as firstDT, max(loc_start) as lastDT',
                       'FROM  ',census_location,
                       sep=" "
                       ),
                 as.is=c(TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE),
                 max=maxQryRows
                 )

locSumm$rowCnt <- format(locSumm$rowCnt, big.mark = ",")
locSumm$primKeyCnt <- format(locSumm$primKeyCnt, big.mark = ",")
locSumm$personCnt <- format(locSumm$personCnt, big.mark = ",")


tmpLastLoc_ <- sqlQuery(sqldb,
                        paste('SELECT distinct a.*',
                              "INTO #tmpLastLoc",
                              "FROM ",census_location," AS a INNER JOIN ",
                              "(SELECT person_id, max(loc_start) as loc_start FROM ",census_location,"group by person_id) AS b",
                              "ON a.person_id = b.person_id and a.loc_start=b.loc_start",
                              sep=' '
                              ),
                        max=maxQryRows
)
lastLocation <- sqlQuery(sqldb,
                         paste("SELECT stateCnty, count(*) as Freq",
                               "FROM (select distinct substring(geocode,1,5) as stateCnty, person_id FROM #tmpLastLoc) as q",
                               "GROUP BY stateCnty",
                               sep=" "),
                       as.is=c(TRUE,TRUE),
                        max=maxQryRows
                         )
lastLocation <- trimChrVars(lastLocation)
 multLastLocs <- sqlQuery(sqldb,
                          paste("SELECT count(distinct person_id) as patsMultLoc",
                                "FROM (select person_id FROM #tmpLastLoc GROUP BY person_id HAVING count(*)>1) as q",
                                sep=" "))
```

Total rows in the dataset: `r locSumm$rowCnt`


Total unique combinations of the primary key: `r locSumm$primKeyCnt `

Total patients in the location table: `r locSumm$personCnt`

Month and year of first location: `r format( as.Date(locSumm$firstDT),"%B %Y")`

Month and year of last location: `r format(as.Date(locSumm$lastDT),"%B %Y")`

`r ifelse(locSumm$rowCnt==locSumm$primKeyCnt," ","The Census Location table has duplicate rows, by person_id and loc_start")`

`r multLastLocs$patsMultLoc` patients have more than one most recent location record


## Table 11. Count of Unique Patients by State and County, Based on Most Recent Location

```{r echo = F, include=T, error=T}
lastLocation <- merge(lastLocation, stateCnty[c('stateCnty','stCntyNm')], by = 'stateCnty', all.x=T) %>% arrange(desc(Freq)) %>% 
                mutate(pct = round(100*Freq/sum(Freq),1),
                       stCntyNm = ifelse(!is.na(stCntyNm), stCntyNm, ifelse( is.na(stateCnty),'Missing','Invalid'))
                     )
```

```{r tab11_disp, echo = F, include=T, error=T}
knitr::kable(lastLocation[c('stateCnty','stCntyNm','Freq','pct')], 
             col.names=c('State/county code','State: county','Frequency','Percent'), 
             row.names=FALSE, 
             format.args = list(big.mark = ","))
```

## Examination of the DIAGNOSES Table

```{r echo = F, include=T, error=T}
diagSumm  <- sqlQuery(sqldb,
                 paste('SELECT count(*) as rowCnt, COUNT(DISTINCT enc_id+dx+CAST(adate AS varchar(10))+diagprovider ) as primKeyCnt, count(distinct person_id) as personCnt, min(adate) as firstDT, max(adate) as lastDT',
                       'FROM  ',diagnoses,
                       sep=" "
                       ),
                 as.is=c(TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE),
                 max=maxQryRows
                 )
```

Total rows in the dataset: `r diagSumm$rowCnt`

Total unique combinations of the primary key: `r diagSumm$primKeyCnt `

Total patients in the table: `r diagSumm$personCnt`

Month and year of first diagnosis: `r format( as.Date(diagSumm$firstDT),"%B %Y")`

Month and year of last diagnosis: `r format( as.Date(diagSumm$lastDT),"%B %Y")`

`r ifelse( diagSumm$rowCnt==diagSumm$primKeyCnt," ","The table has duplicate rows, by enc_id dx adate diagprovider")`

The following tables explore the contents of the DIAGNOSES table with a focus on trends over time and most common types of diagnoses.

## Table 12. Annual Trends in the Total Number of Recorded Diagnoses, the Mean Number of Encounters, the Mean Number of Patients and the Percent Change from the Previous Year, by Calendar Year

This table examines the volume of diagnoses over time and the number of patients with encounters represented in the DIAGNOSES table. Average number of diagnoses per encounter, and per patient, are calculated to compare diagnosis volume trends over time.

```{r tab12_res, echo = F, include=T, error=T}
tab12 <- odbc::dbGetQuery(con, 
  paste0("select year(adate) as year,
    count(*) as nrows, 
    count(distinct enc_id) as nencts,
	  count(distinct person_id) as npats
	  from ", diagnoses, "
	    group by year(adate)
      order by year(adate)"))
tab12_avg_encts <- odbc::dbGetQuery(con, 
  paste0("select year(adate) as year,
    count(*) as nrows
	  from ", diagnoses, "
	    group by year(adate), enc_id
      order by year(adate)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(list(~mean(.), ~median(.), ~min(.), ~max(.))) %>% 
  mutate(
    enct_val = paste0(median, "(", min, ", ", max, ")")
  ) %>% 
  select(enct_val)
tab12_avg_pats <- odbc::dbGetQuery(con, 
  paste0("select year(adate) as year,
    count(*) as nrows
	  from ", diagnoses, "
	    group by year(adate), person_id
      order by year(adate)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(list(~mean(.), ~median(.), ~min(.), ~max(.)))%>% 
  mutate(
    pats_val = paste0(median, "(", min, ", ", max, ")")
  ) %>% 
  select(pats_val)
tab12_add <- tab12 %>% 
  bind_cols(., tab12_avg_encts, tab12_avg_pats) %>% 
  mutate(
    ptc_rec = if_else(is.na(nrows / dplyr::lag(nrows)), "--", paste0(round(nrows / dplyr::lag(nrows) * 100, 0), "%"))
  ) %>% 
  select(year, nrows, ptc_rec, nencts, npats, enct_val, pats_val)
tab12_add$year <- as.character(tab12_add$year)
```

```{r tab12_dis, echo = F, include=T, error=T}
kable(tab12_add, col.names = c("Year", "Total Number of Recorded Diagnoses", "Percent Change from Previous Year", "Total Number of Encounters with 1+ Diagnosis", "Total Number of Unique Patients with 1+ Diagnosis", "Median Number of Diagnoses per Encounter (Min, Max)", "Median Number of Diagnoses per Patient (Min, Max)"), format.args = list(big.mark = ","))
```

## Table 13. Summary  of the Ten Most Common Diagnosis Codes, by All or Ambulatory Encounter Type

These tables include information on the ten most common diagnoses recorded in your DIAGNOSES table. Data on diagnosis codes, types, counts and patients are presented for all encounters and for ambulatory only encounters (ENCTYPE=AV).

```{r tab13_res, echo = F, include=T, error=T}
tab13_dxall <- odbc::dbGetQuery(con, 
  paste0("select dx,
    dx_codetype,
    count(*) as nrows_all,
    count(distinct person_id) as npats
	  from ", diagnoses, "
	    group by dx, dx_codetype")) %>% 
  arrange(desc(nrows_all)) %>% 
  head(., 10) %>% 
  mutate(
    dxCdTp  = paste(dx_codetype,'-',gsub('.','',dx, fixed=T), sep='')
  ) %>% 
  left_join(., icdLU, by = "dxCdTp") %>% 
  select(dx, dx_codetype, dxDesc, nrows_all, npats)
tab13_dxav <- odbc::dbGetQuery(con, 
  paste0("select dx as dx_av,
    dx_codetype as dx_codetype_av,
    count(*) as nrows_av,
    count(distinct person_id) as npats_av
	  from ", diagnoses, "
      where ENCTYPE = 'AV'
	    group by dx, dx_codetype")) %>% 
  arrange(desc(nrows_av)) %>% 
  head(., 10) %>% 
  mutate(
    dxCdTp  = paste(dx_codetype_av,'-',gsub('.','',dx_av, fixed=T), sep='')
  ) %>% 
  left_join(., icdLU, by = "dxCdTp") %>% 
  select(dx_av, dx_codetype_av, dxDesc, nrows_av, npats_av)
tab13_all <- bind_cols(tab13_dxall, tab13_dxav)
```


```{r tab13a_disp, echo = F, include=T, error=T}
kable(tab13_dxall, col.names = c("Diagnosis Code", "Code Type", "Diagnosis Description", "Number of Recorded Diagnoses", "Number of Patients"), format.args = list(big.mark = ","))
```

```{r tab13b_disp, echo = F, include=T, error=T}
kable(tab13_dxav, col.names = c("Diagnosis Code for AV", "Diagnosis Type for AV", "Diagnosis Description", "Number of Recorded Diagnosis for AV", "Number of Patients for AV"), format.args = list(big.mark = ","))
```
 
## Table 14. Summary of the Ten Most Common Diagnoses by Diagnosis Code Type, Total Number of Recorded Diagnoses and Total Number of Recorded Patients
This table includes information on the ten most common diagnoses recorded in your DIAGNOSES table. Data on diagnosis codes, counts and patients are presented for ICD-9 and ICD-10.

```{r tab14_res, echo = F, include=T, error=T}
tab14_09 <- odbc::dbGetQuery(con, 
  paste0("select top 10 dx,
    count(*) as nrows_all,
    count(distinct person_id) as npats
	  from ", diagnoses, "
	    where dx_codetype = '09'
      group by dx
      order by nrows_all DESC"))
tab14_10 <- odbc::dbGetQuery(con, 
  paste0("select top 10 dx,
    count(*) as nrows_all,
    count(distinct person_id) as npats
	  from ", diagnoses, "
	    where dx_codetype = '10'
      group by dx
      order by nrows_all DESC")) 
```

```{r tab14_disp, echo = F, include=T, error=T}
#if and else statements are used to determine if the respecitvie table has any
#rows. If not, then an error message is written indicating so.
if (nrow(tab14_09) != 0){
  kable(tab14_09, col.names = c("Diagnosis", "Records", "Patients"), caption = "Diagnosis Code Type = 09", format.args = list(big.mark = ","))
} else {
   cat(noquote("Table had zero rows.  DX_CODETYPE = '09' likely isn't a category for this variable.\n"))
} 
if (nrow(tab14_10) != 0){
  kable(tab14_10, col.names = c("ProDiagnosiscedure", "Records", "Patients"), caption = "Diagnosis Code Type = 10", format.args = list(big.mark = ","))
} else {
   cat(noquote("Table had zero rows.  DX_CODETYPE = '10' likely isn't a category for this variable.\n"))
} 
```


```{r monthly counts by enc type, echo = F, include=T, error=T}
dxByMonEncTp <- sqlQuery(sqldb,
                      paste("SELECT YEAR(adate) as year, MONTH(adate) as month, enctype, count(*) as Freq",
                            "FROM " ,diagnoses,
                            "GROUP BY YEAR(adate), MONTH(adate), enctype",
                            sep=" "),
                 max=maxQryRows
                 )
dxByMonEncTp <- within(dxByMonEncTp,{
  monYr <- as.Date(paste(as.character(year),as.character(month),'01',sep="-"))
})
dxByMonEncTp <- merge(dxByMonEncTp,encLabels, by.x='enctype', by.y='code', all.x=TRUE) 
dxByMonEncTp <- within(dxByMonEncTp,{decode <- ifelse(!is.na(decode),decode, ifelse(is.na(enctype), 'Missing', 'Invalid'))})
```

## Figure 4a. Count of Diagnoses by Year and Month in Ambulatory Encounters 

```{r Count of diagnoses by year and month in ambulatory encounters, echo = F, include=T, error=T}
ggplot(subset(dxByMonEncTp,enctype == 'AV'), aes(monYr, Freq)) + geom_line() +
  scale_x_date(date_labels = "%b %y",date_breaks='1 year') + xlab("Month of encounter") + ylab("Frequency")+theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Figure 4b. Count of Diagnoses by Year and Month, other Encounter Types

```{r Count of diagnoses by year and month other encounter types, echo = F, include=T, error=T}
ggplot(subset(dxByMonEncTp,enctype != 'AV'), aes(monYr, Freq, colour=decode)) + geom_line() +
  scale_x_date(date_labels = "%b %y",date_breaks='1 year') + xlab("Month of encounter") + ylab("Frequency")+theme(axis.text.x = element_text(angle = 45, hjust = 1))+labs(color='Encounter type')
#,legend.position="bottom" "
```


## Examination of the VITAL_SIGNS Table

```{r vital_signs table Table, echo = F, include=T, error=T}
vitalSumm  <- sqlQuery(sqldb,
                 paste('SELECT count(*) as rowCnt, COUNT(DISTINCT person_id+CAST(measure_date AS varchar(10))+CAST(measure_time AS varchar(20)) ) as primKeyCnt, count(distinct person_id) as personCnt, min(measure_date) as firstDT, max(measure_date) as lastDT',
                       'FROM  ',vital_signs,
                       sep=" "
                       ),
                 max=maxQryRows
                 )
```

Total rows in the dataset: `r vitalSumm$rowCnt`

Total unique combinations of the primary key: `r vitalSumm$primKeyCnt `

Total patients in the table: `r vitalSumm$personCnt`

Month and year of first record: `r format(as.Date(vitalSumm$firstDT),"%B %Y")`

Month and year of last record: `r format(as.Date(vitalSumm$lastDT),"%B %Y")`

`r ifelse(vitalSumm$rowCnt==vitalSumm$primKeyCnt," ","The table has duplicate rows, by person_id, measure_date, measure_time")`


## Table 15. Vital Signs Summary

```{r vital signs summary, echo = F, include=T, error=T}
# be sure to include space breaks in any re-design
vitalVarSumm <- function(var,label){
  
  sqlQuery(sqldb,
                 paste('SELECT variable, minimum, q1, median, q3, maximum, count(*) as nobs, count(distinct person_id) as npats ',
                       'FROM (',
                       "SELECT dummy, variable, person_id, ",var,
                       ', percentile_cont(0.0) WITHIN GROUP (ORDER BY ',var,') OVER(PARTITION BY dummy) as  Minimum',
                       ', percentile_cont(0.25) WITHIN GROUP (ORDER BY ',var,') OVER(PARTITION BY dummy) as  q1',
                       ', percentile_cont(0.5) WITHIN GROUP (ORDER BY ',var,') OVER(PARTITION BY dummy) as  Median',
                       ', percentile_cont(0.75) WITHIN GROUP (ORDER BY ',var,') OVER(PARTITION BY dummy) as  q3',
                       ', percentile_cont(1.0) WITHIN GROUP (ORDER BY ',var,') OVER(PARTITION BY dummy) as  maximum ',
                       'FROM  ',
                         "(SELECT 1 as dummy, '",label,"' as variable, * FROM ",vital_signs,") as q ",
                       'WHERE ',var,' > 0 ) as q2 ',
                       'GROUP BY variable, minimum, q1, median, q3, maximum ',
                       sep=""
                       ),
                 max=maxQryRows,
                 as.is=c(TRUE)
                 )
}
vlst <- do.call('rbind',
                list(vitalVarSumm('ht','Height'),
                     vitalVarSumm('wt','Weight'),
                     vitalVarSumm('systolic','Systolic BP'),
                     vitalVarSumm('diastolic','Diastolic BP')))
vlst <- within(vlst,{
  minimum <- round(as.numeric(minimum),1)
  q1      <- round(as.numeric(q1),1)
  median  <- round(as.numeric(median),1)
  q3      <- round(as.numeric(q3),1)
  maximum <- round(as.numeric(maximum),1)
})
knitr::kable(vlst[c('variable','nobs','npats','minimum','q1','median','q3', 'maximum')], 
             col.names=c('Vital record','Non-null Obs.','Unique patients with Non-null Obs','Minimum','Q1','Median','Q3', 'Maximum'), 
             row.names=FALSE, 
             format.args = list(big.mark = ","))
```

## Table 16. Annual Trends in the Total Number of Recorded Vital Sign Records, the Mean Number of Encounters, the Mean Number of Patients and the Percent Change from the Previous Year, by Calendar Year

This table examines the volume of vital signs over time and the number of patients with encounters represented in the VITAL_SIGNS table. Average number of vital signs per encounter, and per patient, are calculated to compare vital signs volume trends over time; and also to indicate whether or not vital signs are captured in one row or multiple rows for each encounter.

```{r trends in the number of recorded vital signs, tab16_res, echo = F, include=T, error=T}
tab16 <- odbc::dbGetQuery(con, 
  paste0("select year(measure_date) as year,
    count(*) as nrows, 
    count(distinct enc_id) as nencts,
	  count(distinct person_id) as npats
	  from ", vital_signs, "
	    group by year(measure_date)
      order by year(measure_date)"))
tab16_avg_encts <- odbc::dbGetQuery(con, 
  paste0("select year(measure_date) as year,
    count(*) as nrows
	  from ", vital_signs, "
	    group by year(measure_date), enc_id
      order by year(measure_date)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(list(~mean(.), ~median(.), ~min(.), ~max(.))) %>% 
  mutate(
    enct_val = paste0(median, "(", min, ", ", max, ")")
  ) %>% 
  select(enct_val)
tab16_avg_pats <- odbc::dbGetQuery(con, 
 paste0( "select year(measure_date) as year,
    count(*) as nrows
	  from ", vital_signs, "
	    group by year(measure_date), person_id
      order by year(measure_date)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(list(~mean(.), ~median(.), ~min(.), ~max(.)))%>% 
  mutate(
    pats_val = paste0(median, "(", min, ", ", max, ")")
  ) %>% 
  select(pats_val)
tab16_add <- tab16 %>% 
  bind_cols(., tab16_avg_encts, tab16_avg_pats) %>% 
  mutate(
    ptc_rec = if_else(is.na(nrows / dplyr::lag(nrows)), "--", paste0(round(nrows / dplyr::lag(nrows) * 100, 0), "%"))
  ) %>% 
  select(year, nrows, ptc_rec, nencts, npats, enct_val, pats_val)
tab16_add$year <- as.character(tab16_add$year)
```

```{r tab15_dis, echo = F, include=T, error=T}
kable(tab16_add, col.names = c("Year", "Total Number of Recorded Vitals", "Percent Change from Previous Year", "Total Number of Encounters with Vital_Signs", "Total Number of Patients with Vitals", "Median Number of Vitals per Encounter (Min, Max)", "Median Number of Vitals per Patient (Min, Max)"), format.args = list(big.mark = ","))
```


## Figure 5. Count of Vital Signs by Year and Month

```{r Count of vital signs by year and month, echo = F, include=T, error=T}
vitalsByMonYr <- sqlQuery(sqldb,
                 paste('SELECT year(measure_date) as year, month(measure_date) as month',
                       ', sum(case when ht>0 then 1 else 0 end) as height',
                       ', sum(case when wt>0 then 1 else 0 end) as weight',
                       ', sum(case when systolic>0 then 1 else 0 end) as systolic',
                       ', sum(case when diastolic>0 then 1 else 0 end) as diastolic',
                       'FROM  ',vital_signs,
                       'GROUP BY year(measure_date), month(measure_date)',
                       sep=" "
                       ),
                 max=maxQryRows
                 )
vitalsByMonYr <- within(vitalsByMonYr,{
  monYr <- as.Date(paste(as.character(year),as.character(month),'01', sep='-'))
}) %>% subset(select=-c(month,year))
vitalsByMonYrTx <- gather(vitalsByMonYr, 'Vital_record','Count', 1:4)
ggplot(vitalsByMonYrTx, aes(monYr, Count, colour=Vital_record)) + geom_line() +
  scale_x_date(date_labels = "%b %y",date_breaks='1 year') + xlab("Month of encounter") + ylab("Frequency")+theme(axis.text.x = element_text(angle = 45, hjust = 1))+labs(color='Vital type')
```

## Table 17. BENEFIT Table Information

```{r tab17_res, echo = F, include=T, error=T}
 
tab17 <-  odbc::dbGetQuery(con, 
                          paste0("select year(benefit_date) as year,
   count(*) as num_rec,
   SUM(CASE WHEN BENEFIT_CAT = 'CC' THEN 1 ELSE 0 END) as correctional_care,
   SUM(CASE WHEN benefit_cat = 'CO' THEN 1 ELSE 0 END) as comm_private_insurance,
   SUM(CASE WHEN benefit_cat = 'CP' THEN 1 ELSE 0 END) as CHIP,
   SUM(CASE WHEN benefit_cat = 'MC' THEN 1 ELSE 0 END) as medicare,
   SUM(CASE WHEN benefit_cat = 'MD' THEN 1 ELSE 0 END) as medicaid,
   SUM(CASE WHEN benefit_cat = 'OG' THEN 1 ELSE 0 END) as other_gov,
   SUM(CASE WHEN benefit_cat = 'NC' THEN 1 ELSE 0 END) as no_coverage,
   SUM(CASE WHEN benefit_cat = 'OT' THEN 1 ELSE 0 END) as other_ins,
   SUM(CASE WHEN benefit_cat = 'UN' THEN 1 ELSE 0 END) as unknown_ins,
   SUM(CASE WHEN benefit_cat = 'WC' THEN 1 ELSE 0 END) as work_comp,
   SUM(CASE WHEN benefit_cat = 'NI' THEN 1 ELSE 0 END) as na
     from ", benefit, "
       group by year(benefit_date)
       order by year(benefit_date)"))

#Final display
tab17$correctional_care = paste0(format(tab17$correctional_care,big.mark = ",") ,' (',round(tab17$correctional_care/tab17$num_rec*100, digits=1),'%)')
tab17$comm_private_insurance = paste0(format(tab17$comm_private_insurance,big.mark = ",") ,' (',round(tab17$comm_private_insurance/tab17$num_rec*100, digits=1),'%)')
tab17$CHIP = paste0(format(tab17$CHIP,big.mark = ",") ,' (',round(tab17$CHIP/tab17$num_rec*100, digits=1),'%)')
tab17$medicare = paste0(format(tab17$medicare,big.mark = ",") ,' (',round(tab17$medicare/tab17$num_rec*100, digits=1),'%)')
tab17$medicaid = paste0(format(tab17$medicaid,big.mark = ",") ,' (',round(tab17$medicaid/tab17$num_rec*100, digits=1),'%)')
tab17$other_gov = paste0(format(tab17$other_gov,big.mark = ",") ,' (',round(tab17$other_gov/tab17$num_rec*100, digits=1),'%)')
tab17$no_coverage = paste0(format(tab17$no_coverage,big.mark = ",") ,' (',round(tab17$no_coverage/tab17$num_rec*100, digits=1),'%)')
tab17$other_ins = paste0(format(tab17$other_ins,big.mark = ",") ,' (',round(tab17$other_ins/tab17$num_rec*100, digits=1),'%)')
tab17$unknown_ins = paste0(format(tab17$unknown_ins,big.mark = ",") ,' (',round(tab17$unknown_ins/tab17$num_rec*100, digits=1),'%)')
tab17$work_comp = paste0(format(tab17$work_comp,big.mark = ",") ,' (',round(tab17$work_comp/tab17$num_rec*100, digits=1),'%)')
tab17$na = paste0(format(tab17$na,big.mark = ",") ,' (',round(tab17$na/tab17$num_rec*100, digits=1),'%)')

tab17$year <- as.character(tab17$year)

```


```{r tab17.1, echo = F, include=T, error=T}
kable(tab17, col.names = c("Year", "Records", "Correctional Care", "Commercial/Private Insurance",  "CHIP", "Medicare", "Medicaid", "Other Govt. Insurance", "No Coverage", "Other Insurance", "Unknown", "Workers Comp", "NA"), align = 'c', format.args = list(big.mark = ","))
```


## Table 18. LINKAGE Table Information

```{r, echo=FALSE, echo = F, include=T, error=T}
tab18 <- odbc::dbGetQuery(con, 
                          paste0("SELECT COUNT(DISTINCT PERSON_ID) as npats,
                          COUNT(DISTINCT LINK_ID) as nlink
                          FROM ", linkage))

knitr::kable(tab18, col.names = c("Number of unique patient IDs", "Number of unique linkage IDs"), format.args = list(big.mark = ","))
```

####Total program run time:
```{r Calculate program run time, echo=FALSE}
# close odbc
 close(sqldb)
endTime <- Sys.time()
endTime - startTime 
```
title: "P1 QA with new REL questions"
author: "Emily Bacon"
date: "10/23/2019"
output: word_document
---
