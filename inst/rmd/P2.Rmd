
kable(tab3_ord, col.names = c("Year", "Number of Recorded Lab Tests", "Percent Change From Previous Year", "Number of Patients Tested", "Percent Change From Previous Year"), format.args = list(big.mark = ","), align = 'c')
```


## Table 4: CHORDS Priority Lab Tests - Number/Percentage of Tests, Number/Percentage of Patients Tested, Mean Result Values and Result Ranges, by Select TEST_TYPE Values 

This table illustrates the number (and percent) of priority lab test records including the percent of all lab test records , as well as the number (and percent)  of unique patients tested for select TEST_TYPE values. 

```{r tab4_res}
tab4 <- odbc::dbGetQuery(con, 
  paste0("select test_type,
    count(*) as nrows, 
	  count(distinct person_id) as npats,
    avg(result_num) as avg_resval,
    min(result_num) as min_resval,
    max(result_num) as max_resval
	  from ", lab_results, "
	    group by test_type
      order by test_type"))
tab4_tot <- data.frame(test_type = "Total", nrows = tab1_lab$nrows, npats = tab1_lab$npats, avg_resval = NA, min_resval = NA, max_resval = NA)
tab4 <- tab4 %>% 
  mutate(
    pct_rec = round(nrows / tab1_lab$nrows * 100, 1) ,
    pct_pat = round(npats / tab1_lab$npats * 100, 1)
  ) %>% 
  bind_rows(., tab4_tot)
  
```

```{r tab4_disp, results="asis"}

kable(tab4 [c("test_type", "nrows", "pct_rec", "npats", "pct_pat", "avg_resval", "min_resval", "max_resval")], col.names = c("Test Type", "Number of Recorded Lab Tests", "Percentage of All Recorded Tests", "Number of Unique Patients Tested", "Percentage of All Patients", "Mean Result Value", "Minimum Result Value", "Maximum Result Value"), digits = 2, align = 'c', format.args = list(big.mark = ",")) 
```

## Figures 1a-1i: Temporal Trends in the Number of CHORDS Priority Lab Tests, by Select TEST_TYPE Values

These figures shows temporal trends in the number of records for CHORDS priority lab tests.


```{r fig1_res, fig.height=4, fig.width=7}
fig1 <- odbc::dbGetQuery(con, 
  paste0("select test_type, 
    month(result_dt) as month,
    year(result_dt) as year,
    count(*) as nrows
	  from ", lab_results, "
      where test_type in ('HGBA1C', 'PREGNANCY', 'HDL', 'LDL', 'TRIGLYCERIDE', 'GLUCOSE', 'CREATININE', 'HEP_C_RNA', 'HEP_C_ANTIBODY', 'HEP_C_GENOTYPE', 'IGE', 'EOSINOPHIL', 'BNP', 'TROPONIN', 'BLOOD ALCOHOL CONTENT', 'TSPOT', 'QUANTIFERON', 'TUBERCULIN SKIN TEST', 'HEP_C_ANTIBODY', 'HEP_C_GENOTYPE', 'CHLAMYDIA', 'GONORRHEA', 'SYPHILIS','HIV', 'HPV')
	    group by test_type, year(result_dt), month(result_dt)")) 


#some lab results have training whitespace - trim this if applicable	    
trim.trailing <- function(x) sub("\\s+$", "", x)
trim <- function(x) gsub("\\s+$", "", x)
fig1$test_type <- trim(fig1$test_type)

fig1_sub <- fig1 %>% 
  arrange(year, month, test_type) %>% 
  mutate(
    date = as.Date(paste(year, month, "01", sep = "-"))
  ) %>% 
  select(-month, -year)
fig1_wide <- spread(fig1_sub, key = test_type, value = nrows)
lapply(2:ncol(fig1_wide), function(x) 
  ggplot(data = fig1_wide, aes(x = date, y = fig1_wide[[x]])) +
         geom_line() +
    ggtitle(names(fig1_wide)[x]) +
    theme(axis.text.x = element_text(angle=45, margin(b = .5), vjust = .5)) +
    scale_x_date(date_labels = "%b %y",date_breaks='1 year') +
    xlab("Date") + ylab("Number of Records") +
    theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),  
        axis.line = element_line(colour = "black"),
        axis.title = element_text(size = 16, face = "bold"),
        axis.text = element_text(size = 14, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 20))
    ) 

```

## Table 5: Summary of the Ten Most Common Lab Tests - Number/Percentage of Tests and Number/Percentage of Patients Tested, by Select BATTERY_CD Values

This table illustrates the number (and percent) of the data partner's ten most common lab tests and the number (and percent) of unique patients tested with the ten most common lab tests, by the BATTERY_CD field (which captures site-specific lab test names), the percentage of records this represents, and the number and percent of patients in the LAB_RESULTS table who have these results. 

```{r tab5_res}
tab5 <- odbc::dbGetQuery(con, 
                         paste0("select battery_cd,
    count(*) as nrows, 
	  count(distinct person_id) as npats
	  from ", lab_results, "
	    group by battery_cd"))
tab5_sub <- tab5 %>% 
  mutate(
    pct_rec = round(nrows / tab1_lab$nrows, 4) * 100,
    pct_pat = round(npats / tab1_lab$npats, 4) * 100
  ) %>%
  arrange(desc(pct_rec)) %>% 
  head(., 10) %>% 
  select(battery_cd, nrows, pct_rec, npats, pct_pat)
```


```{r tab5_disp, results="asis"}
kable(tab5_sub, col.names = c("BATTERY_CD", "Number of Recorded Lab Tests", "Percentage of All Lab Tests", "Number of Patients Tested", "Percentage of All Patients with a Lab Test"), format.args = list(big.mark = ","))
```

## Examination of the PRESCRIBING Table (Medication Orders and Prescriptions Combined)

The following tables explore the contents of the PRESCRIBING table with a focus on trends over time and most common types of medications ordered. 

## Table 6: Annual Trends in Prescribing Data - the Total Number of Recorded Medication Orders, the Percent Change from the Previous Year, the Total Number of Patients and the Mean, Maximum and Minimum Numbers of Orders & Prescriptions per Patient

This table displays trends in PRESCRIBING record volume over time as well as patient volume represented in the table. PRESCRIBING records are attributed to a year based on RX_ORDER_DATE.


```{r tab6_res}
tab6 <- odbc::dbGetQuery(con, 
                         paste0("select year(rx_order_date) as year,
    count(*) as nrows, 
	  count(distinct person_id) as npats
	  from ", prescribing, "
	    group by year(rx_order_date)
      order by year(rx_order_date)"))
tab6_avg_pats <- odbc::dbGetQuery(con, 
                                  paste0("select year(rx_order_date) as year,
    count(*) as nrows
	  from ", prescribing, "
	    group by year(rx_order_date), person_id
      order by year(rx_order_date)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(funs(mean, median, min, max))%>% 
  mutate(
    pats_val = paste0(median, "(", min, ", ", max, ")")
  )
tab6_all <- left_join(tab6, tab6_avg_pats, by = "year") %>% 
  mutate(
    ptc_rec = if_else(is.na(nrows / dplyr::lag(nrows)), "--", paste0(round(nrows / dplyr::lag(nrows) * 100, 0), "%"))
  ) %>% 
  select(year, nrows, ptc_rec, npats, median, min, max)
tab6_all$year <- as.character(tab6_all$year)
```

```{r tab6_disp, results="asis"}
kable(tab6_all, col.names = c("Year", "Total Number of Prescriptions", "Percent Change From Last Year", "Total Number of Patients", "Median number of Prescriptions per patient", "Minimum Number of Prescriptions Per Patient", "Maximum Number of Prescriptions Per Patient"), align = "c" , format.args = list(big.mark = ","))
```

## Table 7: Summary of the Ten Most Common Medications by Order Type

This table displays the top ten most common orders including count of records and patients. 

```{r tab7_res}
tab7<- odbc::dbGetQuery(con, 
                        paste0("select top 10 GENERIC_MED_NAME,
    count(*) as nrows,
	  count(distinct person_id) as npats,
    round(avg(RX_DAYS_SUPPLY),1) as avg_days_sup,
    round(avg(RX_QUANTITY_NUM),1) as avg_rx_quant
	  from ", prescribing, "
	    group by GENERIC_MED_NAME
      order by nrows DESC"))


```

```{r tab7_disp, results="asis"}
kable(tab7, col.names = c("Medication Name (GENERIC_MED_NAME)", "Records", "Patients", "Average Days Supply", "Average Quantity"), format.args = list(big.mark = ","))
```

## Examination of the PROCEDURES Table 

The following tables explore the contents of the PROCEDURES table with a focus on trends over time and most common types of procedures. 

## Table 8: Annual Trends in the Total Number of Recorded Procedures, the Mean Number of Encounters, the Mean Number of Patients and the Percent Change from the Previous Year, by Calendar Year

This table examines the volume of procedures over time and the number of encounters and patients with represented in the PROCEDURES table. Average number of procedures per encounter, and per patient, are calculated to compare procedure volume trends over time.


```{r tab8_res}
tab8 <- odbc::dbGetQuery(con, 
                         paste0("select year(procdate) as year,
    count(*) as nrows, 
    count(distinct enc_id) as nencts,
	  count(distinct person_id) as npats
	  from ", procedures, "
	    group by year(procdate)
      order by year(procdate)"))
tab8_avg_encts <- odbc::dbGetQuery(con, 
                                   paste("select year(procdate) as year,
    count(*) as nrows
	  from ", procedures, "
	    group by year(procdate), enc_id
      order by year(procdate)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(funs(mean, median, min, max)) %>% 
  mutate(
    enct_val = paste0(median, "(", min, ", ", max, ")")
  ) %>% 
  select(enct_val)
tab8_avg_pats <- odbc::dbGetQuery(con, 
                                  paste0("select year(procdate) as year,
    count(*) as nrows
	  from ", procedures, "
	    group by year(procdate), person_id
      order by year(procdate)")) %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  summarise_all(funs(mean, median, min, max))%>% 
  mutate(
    pats_val = paste0(median, "(", min, ", ", max, ")")
  ) %>% 
  select(pats_val)
tab8_add <- tab8 %>% 
  bind_cols(., tab8_avg_encts, tab8_avg_pats) %>% 
  mutate(
    ptc_rec = if_else(is.na(nrows / dplyr::lag(nrows)), "--", paste0(round(nrows / dplyr::lag(nrows) * 100, 0), "%"))
  ) %>% 
  select(year, nrows, ptc_rec, nencts, npats, enct_val, pats_val)
tab8_add$year <- as.character(tab8_add$year)
```

```{r tab8_dis, results="asis"}
kable(tab8_add, col.names = c("Year", "Total Number of Recorded Procedures", "Percent Change from Previous Year", "Total Number of Encounters with Procedures", "Total Number of Patients with Procedures", "Median Number of Procedures per Encounter (Min, Max)", "Median Number of Procedures per Patient (Min, Max)"),  align= "c", format.args = list(big.mark = ","))
```

## Table 9:  Total Number and Percent of Recorded Encounters, Diagnoses and Procedures, by Encounter Type

This table compares the distribution of procedures, diagnoses and encounters by encounter type. Average diagnosis and procedure counts per encounter are calculated to compare diagnosis and procedure volume by encounter type.

```{r tab9_res}
tab9_enct1 <- odbc::dbGetQuery(con, 
                               paste0("select enctype,
    count(*) as nrows_enct
	  from ", encounters, "
	    group by enctype"))
tab9_enct2 <- odbc::dbGetQuery(con, 
                               paste0("select count(*) as enct_tot
	  from ", encounters))
tab9_diag1 <- odbc::dbGetQuery(con, 
                               paste0("select enctype,
    count(*) as nrows_diag
	  from ", diagnoses, "
	    group by enctype"))
tab9_diag2 <- odbc::dbGetQuery(con, 
                               paste0("select count(*) as diag_tot
	  from ", diagnoses))
tab9_px1 <- odbc::dbGetQuery(con, 
                             paste0("select enctype,
    count(*) as nrows_px
	  from ", procedures, "
	    group by enctype"))
tab9_px2 <- odbc::dbGetQuery(con, 
                             paste0("select count(*) as px_tot
	  from ", procedures))
tab9_tot <- data.frame(enctype = "Total", nrows_enct = tab9_enct2$enct_tot, nrows_diag = tab9_diag2$diag_tot, nrows_px = tab9_px2$px_tot, pct_enct = NA, pct_diag = NA, pct_px = NA)
tab9_all <- tab9_enct1 %>% 
  left_join(., tab9_diag1, by = "enctype") %>% 
  left_join(., tab9_px1, by = "enctype") %>% 
  mutate(
    pct_enct = round(nrows_enct / tab9_enct2$enct_tot * 100,1),
    pct_diag = round(nrows_diag /tab9_diag2$diag_tot *100,1),
    pct_px   = round(nrows_px / tab9_px2$px_tot * 100,1),
    enctype  = recode(enctype, "IP" = "Acute In Patient", "ED" = "Emergency Department", "AV" = "Ambulatory Visit", "TE" = "Telephone Encounter", "EM" = "E-mail Encounter", "IS" = "Non-acute Inpatient", "OE" = "Other Encounters", "LO" = "Lab Only Encounter", "RO" = "Radiology Only Encounter")
  ) %>% 
  bind_rows(., tab9_tot)  
```

```{r tab9_disp, results="asis"}
kable(tab9_all[1:7, c( "enctype", "nrows_enct", "pct_enct", "nrows_enct", "pct_diag", "nrows_px", "pct_px")], col.names = c("Encounter Type", "Number of Encounters", "Percent of Total Encounters", "Number of Diagnoses", "Percent of Total Diagnoses", "Number of Procedures", "Percent of Total Procedures"), digits = 2, format.args = list(big.mark = ","))
```

## Table 10: Summary of the Ten Most Common Procedures - Procedure Code, Procedure Type, Total Number of Recorded Procedures and Total Number of Recorded Patients, by All or Ambulatory Encounter Type 

This table includes information on the ten most common procedures recorded in your PROCEDURE table.  Data on procedure codes, types, counts and patients are presented for all encounters and for ambulatory only encounters (ENCTYPE='AV'). 

```{r tab10_res}
tab10_pxall <- odbc::dbGetQuery(con, 
                                paste0("select px,
    px_codetype,
    count(*) as nrows_all,
    count(distinct person_id) as npats
	  from ", procedures, "
	    group by px, px_codetype")) %>% 
  arrange(desc(nrows_all)) %>% 
  head(., 10)
tab10_pxav <- odbc::dbGetQuery(con, 
                               paste0("select px as px_av,
    px_codetype as px_codetype_av,
    count(*) as nrows_av,
    count(distinct person_id) as npats_av
	  from ", procedures, "
      where ENCTYPE = 'AV'
	    group by px, px_codetype")) %>% 
  arrange(desc(nrows_av)) %>% 
  head(., 10)
tab10_all <- bind_cols(tab10_pxall, tab10_pxav)
```

```{r tab10_disp, results="asis"}
kable(tab10_all, col.names = c("Procedure Code", "Procedure Type", "Number of Recorded Procedures", "Number of Patients", "Procedure Code for AV", "Procedure Type for AV", "Number of Recorded Procedures for AV", "Number of Patients for AV"), align = 'c', format.args = list(big.mark = ","))
```

## Table 11: Summary of the Ten Most Common Procedures by Procedure Code Type, Total Number of Recorded Procedures and Total Number of Recorded Patients 

This table includes information on the ten most common procedures recorded in your PROCEDURE table.  Data on procedure codes, counts and patients are presented for CPT, HCPCS, and other code types. 

```{r tab11_res}
tab11_pxc4 <- odbc::dbGetQuery(con, 
                               paste0("select top 10 px,
    count(*) as nrows_all,
    count(distinct person_id) as npats
	  from ", procedures, "
	    where px_codetype = 'C4'
      group by px
      order by nrows_all DESC"))
tab11_pxh4 <- odbc::dbGetQuery(con, 
                               paste0("select top 10 px,
    count(*) as nrows_all,
    count(distinct person_id) as npats
	  from ", procedures, "
	    where px_codetype = 'H4'
      group by px
      order by nrows_all DESC"))
tab11_px_oth <- odbc::dbGetQuery(con, 
                                 paste0("select top 10 px,
    count(*) as nrows_all,
    count(distinct person_id) as npats
	  from ", procedures, "
	    where px_codetype IN ('09', '10', '11', 'RV', 'LO', 'OT')
      group by px
      order by nrows_all DESC"))
```

```{r tab11_disp, results="asis"}
#if and else statements are used to determine if the respecitvie table has any
#rows. If not, then an error message is written indicating so.
if (nrow(tab11_pxc4) != 0){
  kable(tab11_pxc4, col.names = c("Procedure", "Records", "Patients"), caption = "Procedure Code Type = C4", format.args = list(big.mark = ","))
} else {
  cat(noquote("Table had zero rows.  PX_CODETYPE = C4 likely isn't a category for this variable.\n"))
} 
if (nrow(tab11_pxh4) != 0){
  kable(tab11_pxh4, col.names = c("Procedure", "Records", "Patients"), caption = "Procedure Code Type = H4", format.args = list(big.mark = ","))
} else {
  cat(noquote("Table had zero rows.  PX_CODETYPE = H4 likely isn't a category for this variable.\n"))
} 
if (nrow(tab11_px_oth) != 0){
  kable(tab11_px_oth, col.names = c("Procedure", "Records", "Patients"), caption = "Procedure Code Type = 09, 10, 11, RV, LO, OT", format.args = list(big.mark = ","))
} else {
  cat(noquote("Table had zero rows.  PX_CODETYPE = 09, 10, 11, RV, LO, or OT likely aren't categories for this variable.\n"))
} 
```


## Examination of the PROVIDER_SPECIALTY Table

The following tables explore the contents of the PROVIDER_SPECIALTY table with a focus on demographic data and representativeness of providers across tables.  Note that in some systems providers can be listed multiple times with multiple provider types/specialties. 

## Table 12: Number and Percent of Providers represented in ENCOUNTERS, DIAGNOSIS, LAB_RESULTS, PRESCRIBING, AND PROCEDURES Tables 

This table includes information on the number and percent of providers represented in various CHORDS VDW 3.1 tables.

```{r tab12_res}
tab12_ps <- odbc::dbGetQuery(con, 
                             paste0("select 'PROVIDER_SPECIALTY' as from_tab,
   count(distinct provider) as num_prov
     from ", provider_specialty))
tab12_dx <- odbc::dbGetQuery(con, 
                             paste0("select 'DIAGNOSES' as from_tab,
   count(distinct provider) as num_prov
     from ", diagnoses))
tab12_enct <- odbc::dbGetQuery(con, 
                               paste0("select 'ENCOUNTERS' as from_tab,
   count(distinct provider) as num_prov
     from ", encounters))
tab12_lab <- odbc::dbGetQuery(con, 
                              paste0("select 'LAB_RESULTS' as from_tab,
   count(distinct order_prov) as num_prov 
     from ", lab_results))
tab12_rx <- odbc::dbGetQuery(con, 
                             paste0("select 'PRESCRIBING' as from_tab,
   count(distinct rxmd) as num_prov 
     from ", prescribing))
tab12_px <- odbc::dbGetQuery(con, 
                             paste0("select 'PROCEDURES' as from_tab,
   count(distinct provider) as num_prov
     from ", procedures))
tab12_all <- bind_rows(tab12_ps, tab12_dx, tab12_enct, tab12_lab, tab12_rx, tab12_px) %>% 
  mutate(
    pct_prov = num_prov / tab12_ps$num_prov * 100
  )
```

```{r tab12_disp, results="asis"}
kable(tab12_all, col.names = c("Table", "Number of Providers*", "Percent of All Providers"), digits = 2, format.args = list(big.mark = ","))
```
*Excludes Provider = 'Unknown'

## Table 13: Number and Percent of Providers by Specialty

This table includes information on the distribution of providers by specialty.

```{r tab13_res}
tab13 <- odbc::dbGetQuery(con, 
                          paste0("select specialty as spec,
   count(distinct provider) as num_prov
     from ", provider_specialty, "
       group by specialty
       order by specialty")) %>% 
  bind_rows(data.frame(spec = "NULL", num_prov = tab2_ps_null$SPECIALTY)) %>% 
  mutate(
    pct_prov = num_prov / tab12_ps$num_prov * 100
  ) 
tab13$spec_full <- specialties$Description[match(as.character(tab13$spec), as.character(specialties$SPECIALTY))]
tab13 <- tab13[, c(1,4,2,3)]
```
```{r tab13_disp, results = "asis"}
kable(tab13, col.names = c("Specialty Abbreviation", "Specialty", "Number of Providers", "Percent of All Providers"), digits = 2, format.args = list(big.mark = ","))
```

## Table 14: Number and Percent of Provider by Provider Type 

This table includes information on the distribution of providers by type.

```{r tab14_res}
tab14 <- odbc::dbGetQuery(con, 
                          paste0("select provider_type as prov_type,
   count(distinct provider) as num_prov
     from ", provider_specialty, "
       group by provider_type
       order by provider_type")) %>% 
  bind_rows(data.frame(prov_type = "NULL", num_prov = tab2_ps_null$PROVIDER_TYPE)) %>% 
  mutate(
    pct_prov = num_prov / tab12_ps$num_prov * 100
  ) 
tab14$prov_type <- as.numeric(tab14$prov_type)
tab14$spec_full <- prov_type$V2[match(tab14$prov_type, prov_type$V1)]
tab14$spec_full[is.na(tab14$spec_full)] <- "Unknown"
tab14 <- tab14[, c(1,4,2,3)]
```
```{r tab14_disp, results = "asis"}
kable(tab14, col.names = c("Provider Abbreviation", "Provider Type", "Number of Providers", "Percent of All Providers"), digits = 2, align = 'l', format.args = list(big.mark = ","))
```

## Table 15: Annual Trends in Self-Reported Tobacco Use

This table includes information on the distribution of SOCIAL_HISTORY records by TOBACCO_USER value.

```{r tab15_res}
tab15 <- odbc::dbGetQuery(con, 
                          paste0("select year(contact_date) as year,
   count(*) as num_rec,
   SUM(CASE WHEN TOBACCO_USER = 'Y' THEN 1 ELSE 0 END) as smoker,
   SUM(CASE WHEN TOBACCO_USER = 'I' THEN 1 ELSE 0 END) as infreq,
   SUM(CASE WHEN TOBACCO_USER = 'Q' THEN 1 ELSE 0 END) as former,
   SUM(CASE WHEN TOBACCO_USER = 'P' THEN 1 ELSE 0 END) as passive,
   SUM(CASE WHEN TOBACCO_USER = 'N' THEN 1 ELSE 0 END) as never,
   SUM(CASE WHEN TOBACCO_USER IN ('X', 'U') THEN 1 ELSE 0 END) as unknown,
   SUM(CASE WHEN TOBACCO_USER IS NULL THEN 1 ELSE 0 END) as t_null
      from ", social_history, "
       group by year(contact_date)
       order by year(contact_date)"))


#Add percents to each tobacco user type
tab15$smoker <- paste0(format(tab15$smoker, big.mark = ","), " (", round(100* tab15$smoker/tab15$num_rec,1), "%)")
tab15$infreq <- paste0(format(tab15$infreq, big.mark = ","), " (", round(100* tab15$infreq/tab15$num_rec,1), "%)")
tab15$former <- paste0(format(tab15$former, big.mark = ","), " (", round(100* tab15$former/tab15$num_rec,1), "%)")
tab15$passive <- paste0(format(tab15$passive, big.mark = ","), " (", round(100* tab15$passive/tab15$num_rec,1), "%)")
tab15$never <- paste0(format(tab15$never, big.mark = ","), " (", round(100* tab15$never/tab15$num_rec,1), "%)")
tab15$unknown <- paste0(format(tab15$unknown, big.mark = ","), " (", round(100* tab15$unknown/tab15$num_rec,1), "%)")

tab15$year <- as.character(tab15$year)

```
```{r tab15_disp, results="asis"}
kable(tab15, col.names = c("Year", "Records", "Yes/Current (%)", "Infrequent(%) ", "Quit/Former (%)", "Passive/Second Hand Smoke Exposure (%)", "Never (%)", "Not Asked/Unknown (%)", "Null"), align = 'c', format.args = list(big.mark = ","))
```

## Table 16: Annual Trends in Self-Reported Alcohol Use

This table includes information on the distribution of SOCIAL_HISTORY records by ALCOHOL_USER value.


```{r tab16_res}
tab16 <- odbc::dbGetQuery(con, 
                          paste0("select year(contact_date) as year,
   count(*) as num_rec,
   SUM(CASE WHEN ALCOHOL_USER = 'Y' THEN 1 ELSE 0 END) as alc_use,
   SUM(CASE WHEN ALCOHOL_USER = 'Q' THEN 1 ELSE 0 END) as former,
   SUM(CASE WHEN ALCOHOL_USER = 'N' THEN 1 ELSE 0 END) as never,
   SUM(CASE WHEN ALCOHOL_USER IN ('X', 'U') THEN 1 ELSE 0 END) as unknown,
   SUM(CASE WHEN ALCOHOL_USER IS NULL THEN 1 ELSE 0 END) as t_null
     from ", social_history, "
       group by year(contact_date)
       order by year(contact_date)"))
#Add percents to each tobacco user type
tab16$alc_use <- paste0(format(tab16$alc_use, big.mark = ","), " (", round(100* tab16$alc_use/tab16$num_rec,1), "%)")
tab16$former <- paste0(format(tab16$former, big.mark = ","), " (", round(100* tab16$former/tab16$num_rec,1), "%)")
tab16$never <- paste0(format(tab16$never, big.mark = ","), " (", round(100* tab16$never/tab16$num_rec,1), "%)")
tab16$unknown <- paste0(format(tab16$unknown, big.mark = ","), " (", round(100* tab16$unknown/tab16$num_rec,1), "%)")
tab16$year <- as.character(tab16$year)
```

```{r tab16_disp, results="asis"}
kable(tab16, col.names = c("Year", "Records", "Yes/Current", "Quit/Former",  "Never", "Not Asked/Unknown", "Null"), align = 'c', format.args = list(big.mark = ","))
```

## Table 17: Annual Trends in Self-Reported Illicit Drug Use

This table includes information on the distribution of SOCIAL_HISTORY records by ILL_DRUG_USER value.

```{r tab17_res}
tab17 <- odbc::dbGetQuery(con, 
                          paste0("select year(contact_date) as year,
   count(*) as num_rec,
   SUM(CASE WHEN ILL_DRUG_USER = 'Y' THEN 1 ELSE 0 END) as ill_drug,
   SUM(CASE WHEN ILL_DRUG_USER = 'Q' THEN 1 ELSE 0 END) as former,
   SUM(CASE WHEN ILL_DRUG_USER = 'N' THEN 1 ELSE 0 END) as never,
   SUM(CASE WHEN ILL_DRUG_USER IN ('X', 'U') THEN 1 ELSE 0 END) as unknown,
   SUM(CASE WHEN ILL_DRUG_USER IS NULL THEN 1 ELSE 0 END) as t_null
     from ", social_history, "
       group by year(contact_date)
       order by year(contact_date)"))
tab17$ill_drug <- paste0(format(tab17$ill_drug, big.mark = ","), " (", round(100* tab17$ill_drug/tab17$num_rec,1), "%)")
tab17$former <- paste0(format(tab17$former, big.mark = ","), " (", round(100* tab17$former/tab17$num_rec,1), "%)")
tab17$never <- paste0(format(tab17$never, big.mark = ","), " (", round(100* tab17$never/tab17$num_rec,1), "%)")
tab17$unknown <- paste0(format(tab17$unknown, big.mark = ","), " (", round(100* tab17$unknown/tab17$num_rec,1), "%)")
tab17$year <- as.character(tab17$year)
```

```{r tab17_disp, results="asis"}
kable(tab17, col.names = c("Year", "Records", "Yes/Current", "Quit/Former",  "Never", "Not Asked/Unknown", "Null"), align = 'c', format.args = list(big.mark = ","))
```

## Table 18: PRO_Surveys Table

This table shows the behavioral and social surveys that have been loaded into the VDW. Note that it does not show the responses to the surveys.

```{r tab18_res}
tab18 <- sqlQuery(sqldb, "select * from pro_surveys")
```

```{r tab18_disp, results="asis"}
kable(tab18)
```

## Table 19: PRO_Questions Table

This table shows the behavioral and social survey questions that have been loaded into the VDW. Note that it does not show the responses to the surveys.

```{r tab19_res}
tab19 <- sqlQuery(sqldb, "select * from pro_questions")
```

```{r tab18_disp, results="asis"}
kable(tab19)
```

## Table 20: PRO_Responses Table

This table shows the responses for each of the behavioral and social surveys that have been loaded into the VDW.

```{r tab20_res}
tab20 <- 
```





















####Total program run time:
```{r calc_runtime}
# close odbc
DBI::dbDisconnect(con)
endTime <- Sys.time()
runtime <- endTime - startTime 
```


Query run time = `r runtime` minutes
